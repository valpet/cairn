<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Ticket</title>
  <style>
    body {
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      color: var(--vscode-foreground);
      background-color: var(--vscode-editor-background);
      margin: 0;
      padding: 20px;
    }

    h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 24px 0;
    }

    h3 {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 16px 0;
    }

    .editor-layout {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

    .main-content {
      flex: 1;
      min-width: 0;
    }

    .metadata-card {
      width: 280px;
      flex-shrink: 0;
      background-color: rgba(0, 0, 0, 0.08);
      border: 1px solid var(--vscode-widget-border);
      border-radius: 4px;
      padding: 16px;
      margin-top: 0;
    }

    .metadata-card h3 {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 600;
    }

    .metadata-item {
      margin-bottom: 12px;
    }

    .metadata-item:last-child {
      margin-bottom: 0;
    }

    .metadata-label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: var(--vscode-descriptionForeground);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .metadata-value select {
      width: 100%;
      padding: 4px 6px;
      font-size: 13px;
      border: 1px solid var(--vscode-input-border, transparent);
      border-radius: 3px;
      background-color: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      outline: none;
    }

    .metadata-value select:focus {
      border-color: var(--vscode-focusBorder);
      outline: 1px solid var(--vscode-focusBorder);
      outline-offset: -1px;
    }

    .metadata-value.date-value {
      display: flex;
      align-items: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 500;
    }

    .editable-field {
      position: relative;
    }

    .field-display {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 6px 8px;
      min-height: 32px;
      border: 1px solid transparent;
      border-radius: 2px;
      cursor: pointer;
    }

    .field-display:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .field-text {
      flex: 1;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .field-text.placeholder {
      color: var(--vscode-input-placeholderForeground);
      font-style: italic;
    }

    .edit-icon {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
      opacity: 0.6;
    }

    .edit-icon:hover {
      opacity: 1;
    }

    .field-edit {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .field-edit input,
    .field-edit textarea {
      flex: 1;
    }

    .edit-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .icon-button {
      width: 28px;
      height: 28px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--vscode-button-border, transparent);
      border-radius: 2px;
      cursor: pointer;
    }

    .icon-button svg {
      width: 16px;
      height: 16px;
    }

    .icon-button.accept {
      color: var(--vscode-button-foreground);
      background-color: var(--vscode-button-background);
    }

    .icon-button.accept:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    .icon-button.cancel {
      color: var(--vscode-button-secondaryForeground);
      background-color: var(--vscode-button-secondaryBackground);
    }

    .icon-button.cancel:hover {
      background-color: var(--vscode-button-secondaryHoverBackground);
    }

    .hidden {
      display: none !important;
    }

    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 6px 8px;
      box-sizing: border-box;
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      color: var(--vscode-input-foreground);
      background-color: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border, transparent);
      outline: none;
      border-radius: 2px;
    }

    input[type="text"]:focus,
    select:focus,
    textarea:focus {
      border-color: var(--vscode-focusBorder);
      outline: 1px solid var(--vscode-focusBorder);
      outline-offset: -1px;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    button {
      padding: 6px 14px;
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      color: var(--vscode-button-foreground);
      background-color: var(--vscode-button-background);
      border: none;
      border-radius: 2px;
      cursor: pointer;
      outline: none;
    }

    button:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    button:focus {
      outline: 1px solid var(--vscode-focusBorder);
      outline-offset: 2px;
    }

    button.secondary {
      color: var(--vscode-button-secondaryForeground);
      background-color: var(--vscode-button-secondaryBackground);
    }

    button.secondary:hover {
      background-color: var(--vscode-button-secondaryHoverBackground);
    }

    .subtasks-section {
      margin-top: 24px;
      padding: 16px;
      background-color: rgba(0, 0, 0, 0.08);
      border-radius: 4px;
      border: 1px solid var(--vscode-widget-border);
    }

    .dependencies-section {
      margin-top: 24px;
      padding: 16px;
      background-color: rgba(0, 0, 0, 0.08);
      border-radius: 4px;
      border: 1px solid var(--vscode-widget-border);
    }

    .title-description-section {
      margin-top: 0;
      padding: 16px;
      background-color: rgba(0, 0, 0, 0.08);
      border-radius: 4px;
      border: 1px solid var(--vscode-widget-border);
    }

    .title-description-section h3 {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 600;
    }

    .dependency-section {
      margin-bottom: 16px;
    }

    .dependency-section h4 {
      margin: 0 0 8px 0;
      font-size: 13px;
      font-weight: 500;
      color: var(--vscode-descriptionForeground);
    }

    .dependency-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .dependency {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid var(--vscode-list-inactiveSelectionBackground);
      border-radius: 3px;
      margin-bottom: 4px;
    }

    .dependency-direction {
      font-size: 14px;
      font-weight: bold;
      color: var(--vscode-descriptionForeground);
      min-width: 20px;
    }

    .dependency-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dependency-type,
    .dependency-status,
    .dependency-priority {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      display: inline-block;
      text-transform: capitalize;
    }

    .dependency-type {
      background-color: var(--vscode-badge-background);
      color: var(--vscode-badge-foreground);
    }

    .dependency-status.open {
      background-color: rgba(46, 160, 67, 0.2);
      color: #3fb950;
    }

    .dependency-status.in_progress {
      background-color: rgba(68, 131, 255, 0.2);
      color: #58a6ff;
    }

    .dependency-status.closed {
      background-color: rgba(139, 148, 158, 0.2);
      color: #8b949e;
    }

    .dependency-status.blocked {
      background-color: rgba(218, 54, 51, 0.2);
      color: #f85149;
    }

    .dependency-priority.low {
      background-color: rgba(46, 160, 67, 0.2);
      color: #3fb950;
    }

    .dependency-priority.medium {
      background-color: rgba(212, 165, 86, 0.2);
      color: #D4A556;
    }

    .dependency-priority.high {
      background-color: rgba(251, 133, 0, 0.2);
      color: #fb8500;
    }

    .dependency-priority.urgent {
      background-color: rgba(218, 54, 51, 0.2);
      color: #f85149;
    }

    .dependency-title {
      flex: 1;
      font-weight: 500;
    }

    .dependency-id {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      font-family: monospace;
    }

    .dependency-list-modal {
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--vscode-widget-border);
      border-radius: 3px;
    }

    .dependency-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid var(--vscode-list-inactiveSelectionBackground);
      cursor: pointer;
    }

    .dependency-item:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .dependency-item.selected {
      background-color: var(--vscode-list-activeSelectionBackground);
    }

    .dependency-checkbox {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      flex-shrink: 0;
      accent-color: var(--vscode-button-background);
    }

    .dependency-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background-color: var(--vscode-quickInput-background);
      border: 1px solid var(--vscode-widget-border);
      border-radius: 6px;
      width: 90%;
      max-width: 600px;
      max-height: 80%;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--vscode-widget-border);
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .modal-body {
      padding: 16px;
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .search-input {
      width: 100%;
      margin-bottom: 12px;
      padding: 8px 12px;
      box-sizing: border-box;
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      color: var(--vscode-input-foreground);
      background-color: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border);
      border-radius: 3px;
      outline: none;
    }

    .search-input:focus {
      border-color: var(--vscode-focusBorder);
      outline: 1px solid var(--vscode-focusBorder);
      outline-offset: -1px;
    }

    .subtask-list-modal {
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--vscode-widget-border);
      border-radius: 3px;
    }

    .subtask-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid var(--vscode-list-inactiveSelectionBackground);
      cursor: pointer;
    }

    .subtask-item:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .subtask-item.selected {
      background-color: var(--vscode-list-activeSelectionBackground);
    }

    .subtask-checkbox {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      flex-shrink: 0;
      accent-color: var(--vscode-button-background);
    }

    .subtask-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .subtask-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .subtask-type,
    .subtask-status,
    .subtask-priority {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      display: inline-block;
      text-transform: capitalize;
    }

    .subtask-type {
      background-color: var(--vscode-badge-background);
      color: var(--vscode-badge-foreground);
    }

    .subtask-status.open {
      background-color: rgba(46, 160, 67, 0.2);
      color: #3fb950;
    }

    .subtask-status.in_progress {
      background-color: rgba(68, 131, 255, 0.2);
      color: #58a6ff;
    }

    .subtask-status.closed {
      background-color: rgba(139, 148, 158, 0.2);
      color: #8b949e;
    }

    .subtask-status.blocked {
      background-color: rgba(218, 54, 51, 0.2);
      color: #f85149;
    }

    .subtask-priority.low {
      background-color: rgba(46, 160, 67, 0.2);
      color: #3fb950;
    }

    .subtask-priority.medium {
      background-color: rgba(212, 165, 86, 0.2);
      color: #D4A556;
    }

    .subtask-priority.high {
      background-color: rgba(251, 133, 0, 0.2);
      color: #fb8500;
    }

    .subtask-priority.urgent {
      background-color: rgba(218, 54, 51, 0.2);
      color: #f85149;
    }

    .subtask-title {
      flex: 1;
      font-weight: 500;
    }

    .subtask-id {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      font-family: monospace;
    }

    .modal-footer {
      padding: 16px;
      border-top: 1px solid var(--vscode-widget-border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* Type badge styles (matching task list) */
    .type-badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
      height: 22px;
      line-height: 1;
    }

    .type-badge::before {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      line-height: 1;
    }

    .type-badge.epic {
      background-color: rgba(138, 98, 255, 0.2);
      color: #8A62FF;
    }

    .type-badge.epic::before {
      content: '‚ö°';
    }

    .type-badge.task {
      background-color: rgba(68, 131, 255, 0.2);
      color: #4483FF;
    }

    .type-badge.task::before {
      content: '‚Ä¢';
      font-size: 16px;
    }

    .type-badge.bug {
      background-color: rgba(218, 54, 51, 0.2);
      color: #f85149;
    }

    .type-badge.bug::before {
      content: 'üêõ';
      font-size: 11px;
    }

    .type-badge.feature {
      background-color: rgba(46, 160, 67, 0.2);
      color: #3fb950;
    }

    .type-badge.feature::before {
      content: '‚ú®';
      font-size: 11px;
    }

    .type-badge.chore {
      background-color: rgba(139, 148, 158, 0.2);
      color: #8b949e;
    }

    .type-badge.chore::before {
      content: 'üîß';
      font-size: 11px;
    }

    .type-badge.docs {
      background-color: rgba(88, 166, 255, 0.2);
      color: #58a6ff;
    }

    .type-badge.docs::before {
      content: 'üìù';
      font-size: 11px;
    }

    .type-badge.refactor {
      background-color: rgba(212, 165, 86, 0.2);
      color: #D4A556;
    }

    .type-badge.refactor::before {
      content: '‚ôªÔ∏è';
      font-size: 11px;
    }

    /* Delete button and confirmation popup */
    .delete-ticket-btn {
      background-color: #f85149;
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 2px;
      cursor: pointer;
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      margin-top: 20px;
      position: relative;
    }

    .delete-ticket-btn:hover {
      background-color: #da3633;
    }

    .delete-ticket-btn:focus {
      outline: 1px solid var(--vscode-focusBorder);
      outline-offset: 2px;
    }

    .delete-confirm-popup {
      position: absolute;
      background-color: var(--vscode-dropdown-background);
      border: 1px solid #f85149;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      padding: 12px;
      z-index: 2000;
      min-width: 220px;
      display: none;
    }

    .delete-confirm-popup.visible {
      display: block;
    }

    .delete-confirm-text {
      color: var(--vscode-foreground);
      font-size: 13px;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .delete-confirm-text strong {
      color: #f85149;
    }

    .delete-confirm-buttons {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .delete-confirm-btn {
      padding: 4px 12px;
      border: none;
      border-radius: 3px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s;
    }

    .delete-confirm-btn.delete {
      background-color: #f85149;
      color: white;
    }

    .delete-confirm-btn.delete:hover {
      background-color: #da3633;
    }

    .delete-confirm-btn.cancel {
      background-color: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
    }

    .delete-confirm-btn.cancel:hover {
      background-color: var(--vscode-button-secondaryHoverBackground);
    }

    /* Comments section */
    .comments-section {
      margin-top: 24px;
      padding: 16px;
      background-color: rgba(0, 0, 0, 0.08);
      border-radius: 4px;
      border: 1px solid var(--vscode-widget-border);
    }

    .comments-header {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 600;
    }

    .comments-thread {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .comment-item {
      padding: 12px;
      background-color: var(--vscode-editor-background);
      border-radius: 4px;
      border-left: 3px solid var(--vscode-focusBorder);
    }

    .comment-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .comment-author {
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .comment-author.agent {
      color: #58a6ff;
    }

    .comment-timestamp {
      color: var(--vscode-descriptionForeground);
      font-size: 11px;
    }

    .comment-content {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 13px;
      line-height: 1.6;
      color: var(--vscode-editor-foreground);
    }

    .comments-empty {
      color: var(--vscode-input-placeholderForeground);
      font-style: italic;
      padding: 12px;
      text-align: center;
    }

    .add-comment-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-top: 1px solid var(--vscode-widget-border);
      padding-top: 12px;
    }

    .add-comment-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .add-comment-header label {
      font-size: 12px;
      font-weight: 500;
    }

    #commentAuthor {
      width: 150px;
      padding: 4px 8px;
      font-size: 12px;
    }

    #commentInput {
      width: 100%;
      min-height: 80px;
      padding: 8px;
      font-family: var(--vscode-editor-font-family);
      font-size: 13px;
      resize: vertical;
    }

    .add-comment-actions {
      display: flex;
      justify-content: flex-end;
    }
  </style>
</head>

<body>
  <h1>Edit Ticket</h1>
  <form id="ticketForm">
    <div class="editor-layout">
      <div class="main-content">
        <div class="title-description-section">
          <h3>Title & Description</h3>
          <div class="field-group">
            <label for="titleContainer">Title</label>
            <div id="titleContainer"></div>
          </div>
          <div class="field-group">
            <label for="descriptionContainer">Description</label>
            <div id="descriptionContainer"></div>
          </div>
        </div>
      </div>

      <div class="metadata-card">
        <h3>Properties</h3>
        
        <div class="metadata-item">
          <label class="metadata-label">Type</label>
          <div class="metadata-value">
            <select id="type" onchange="saveTicket()">
              <option value="task">Task</option>
              <option value="bug">Bug</option>
              <option value="feature">Feature</option>
              <option value="epic">Epic</option>
              <option value="chore">Chore</option>
              <option value="docs">Docs</option>
              <option value="refactor">Refactor</option>
            </select>
          </div>
        </div>

        <div class="metadata-item">
          <label class="metadata-label">Priority</label>
          <div class="metadata-value">
            <select id="priority" onchange="saveTicket()">
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
        </div>

        <div class="metadata-item">
          <label class="metadata-label">Status</label>
          <div class="metadata-value">
            <select id="status" onchange="onStatusChange(); saveTicket()">
              <option value="open">Open</option>
              <option value="in_progress">In Progress</option>
              <option value="closed">Closed</option>
              <option value="blocked">Blocked</option>
            </select>
          </div>
        </div>

        <div class="metadata-item">
          <label class="metadata-label">Created</label>
          <div class="metadata-value date-value" id="createdDate">-</div>
        </div>

        <div class="metadata-item">
          <label class="metadata-label">Updated</label>
          <div class="metadata-value date-value" id="updatedDate">-</div>
        </div>

        <div class="metadata-item" id="closedDateContainer" style="display: none;">
          <label class="metadata-label">Closed</label>
          <div class="metadata-value date-value" id="closedDate">-</div>
        </div>

        <div class="metadata-item">
          <label class="metadata-label">ID</label>
          <div class="metadata-value" id="ticketId">-</div>
        </div>
      </div>
    </div>
    <div class="subtasks-section">
      <h3>Subtasks</h3>
      <div id="subtasksList" class="subtask-list"></div>
      <button type="button" id="addSubtask" class="secondary">Add Subtask</button>
    </div>
    <div class="dependencies-section">
      <h3>Dependencies</h3>
      <div class="dependency-section">
        <h4>Blocked by</h4>
        <div id="blockedByList" class="dependency-list"></div>
      </div>
      <div class="dependency-section">
        <h4>This issue is blocking</h4>
        <div id="blockingList" class="dependency-list"></div>
      </div>
      <button type="button" id="addDependency" class="secondary">Add Dependency</button>
    </div>
    <div class="comments-section">
      <h3 class="comments-header">Comments</h3>
      <div class="comments-thread" id="commentsThread">
        <div class="comments-empty">No comments yet. Add a comment below to start the conversation.</div>
      </div>
      <div class="add-comment-form">
        <div class="add-comment-header">
          <label for="commentAuthor">Author:</label>
          <input type="text" id="commentAuthor" placeholder="your-name or agent" value="user" />
        </div>
        <textarea id="commentInput" placeholder="Add a comment..."></textarea>
        <div class="add-comment-actions">
          <button type="button" id="addCommentBtn">Add Comment</button>
        </div>
      </div>
    </div>
    <button type="button" id="deleteTicket" class="delete-ticket-btn">Delete Ticket</button>
  </form>

  <!-- Subtask Selection Modal -->
  <div id="subtaskModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Select Subtask</h2>
      </div>
      <div class="modal-body">
        <input type="text" id="subtaskSearch" class="search-input"
          placeholder="Search by ID, title, or description..." />
        <div id="availableSubtasks" class="subtask-list-modal"></div>
      </div>
      <div class="modal-footer">
        <button type="button" id="cancelSubtaskSelection" class="secondary">Cancel</button>
        <button type="button" id="confirmSubtaskSelection">Add Selected Subtasks</button>
      </div>
    </div>
  </div>

  <!-- Dependency Selection Modal -->
  <div id="dependencyModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Select Dependencies</h2>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 12px;">
          <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500;">Dependency Direction:</label>
          <div style="display: flex; gap: 16px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
              <input type="radio" name="dependencyDirection" value="blocks" checked>
              This task depends on selected tasks (blockers)
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
              <input type="radio" name="dependencyDirection" value="blocked_by">
              Selected tasks depend on this task (blocked by)
            </label>
          </div>
        </div>
        <input type="text" id="dependencySearch" class="search-input"
          placeholder="Search by ID, title, or description..." />
        <div id="availableDependencies" class="dependency-list-modal"></div>
      </div>
      <div class="modal-footer">
        <button type="button" id="cancelDependencySelection" class="secondary">Cancel</button>
        <button type="button" id="confirmDependencySelection">Add Selected Dependencies</button>
      </div>
    </div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();
    let ticketId = null;
    let subtasks = [];
    let dependencies = [];
    let currentTitle = '';
    let currentDescription = '';
    let comments = [];
    let availableSubtasks = [];
    let selectedSubtaskIds = new Set();
    let availableDependencies = [];
    let selectedDependencyIds = new Set();

    // Reusable EditableField component
    class EditableField {
      constructor(options) {
        this.fieldName = options.fieldName;
        this.placeholder = options.placeholder || 'Click to edit...';
        this.isTextarea = options.isTextarea || false;
        this.onSave = options.onSave;
        this.onCancel = options.onCancel;
        this.onDisplayUpdate = options.onDisplayUpdate;
        
        this.container = null;
        this.displayElement = null;
        this.editElement = null;
        this.inputElement = null;
        this.originalValue = '';
        this.currentValue = '';
        this.isDirty = false;
        
        this.init();
      }
      
      init() {
        // Create container
        this.container = document.createElement('div');
        this.container.className = 'editable-field';
        
        // Create display element
        this.displayElement = document.createElement('div');
        this.displayElement.className = 'field-display';
        this.displayElement.onclick = () => this.enterEditMode();
        
        const textElement = document.createElement('div');
        textElement.className = 'field-text';
        this.displayElement.appendChild(textElement);
        
        const icon = document.createElement('svg');
        icon.className = 'edit-icon';
        icon.setAttribute('viewBox', '0 0 16 16');
        icon.setAttribute('fill', 'currentColor');
        const path = document.createElement('path');
        path.setAttribute('d', 'M13.23 1h-1.46L3.52 9.25l-.16.22L2 13.59l4.12-1.36.22-.16L14.59 3.23V1.77L13.23 1zM2.41 13.59l.72-2.17 1.45 1.45-2.17.72zm2.5-2.07L3.53 10.1 10.8 2.83l1.38 1.38-7.27 7.27z');
        icon.appendChild(path);
        this.displayElement.appendChild(icon);
        
        // Create edit element
        this.editElement = document.createElement('div');
        this.editElement.className = 'field-edit hidden';
        
        this.inputElement = document.createElement(this.isTextarea ? 'textarea' : 'input');
        if (!this.isTextarea) {
          this.inputElement.type = 'text';
        }
        this.inputElement.className = this.isTextarea ? '' : 'input';
        if (this.isTextarea) {
          this.inputElement.rows = 4;
        }
        this.inputElement.onblur = () => this.handleBlur();
        this.inputElement.onkeydown = (e) => this.handleKeydown(e);
        
        const actions = document.createElement('div');
        actions.className = 'edit-actions';
        
        const acceptBtn = document.createElement('button');
        acceptBtn.type = 'button';
        acceptBtn.className = 'icon-button accept';
        acceptBtn.title = 'Save';
        acceptBtn.onclick = () => this.save();
        
        const acceptSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        acceptSvg.setAttribute('viewBox', '0 0 16 16');
        acceptSvg.setAttribute('fill', 'currentColor');
        const acceptPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        acceptPath.setAttribute('d', 'M14.431 3.323l-8.47 10-.79-.036-3.35-4.77.818-.574 2.978 4.24 8.051-9.506.764.646z');
        acceptSvg.appendChild(acceptPath);
        acceptBtn.appendChild(acceptSvg);
        
        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'icon-button cancel';
        cancelBtn.title = 'Cancel';
        cancelBtn.onclick = () => this.cancel();
        
        const cancelSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        cancelSvg.setAttribute('viewBox', '0 0 16 16');
        cancelSvg.setAttribute('fill', 'currentColor');
        const cancelPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        cancelPath.setAttribute('d', 'M8 8.707l3.646 3.647.708-.707L8.707 8l3.647-3.646-.707-.708L8 7.293 4.354 3.646l-.707.708L7.293 8l-3.646 3.646.707.708L8 8.707z');
        cancelSvg.appendChild(cancelPath);
        cancelBtn.appendChild(cancelSvg);
        
        actions.appendChild(acceptBtn);
        actions.appendChild(cancelBtn);
        
        this.editElement.appendChild(this.inputElement);
        this.editElement.appendChild(actions);
        
        this.container.appendChild(this.displayElement);
        this.container.appendChild(this.editElement);
        console.log('EditableField init completed, container:', this.container);
      }
      
      getElement() {
        console.log('getElement called, container:', this.container);
        return this.container;
      }
      
      setValue(value) {
        this.currentValue = value || '';
        this.originalValue = this.currentValue;
        this.updateDisplay();
      }
      
      updateDisplay() {
        const textElement = this.displayElement.querySelector('.field-text');
        if (!this.currentValue) {
          textElement.textContent = this.placeholder;
          textElement.classList.add('placeholder');
        } else {
          textElement.textContent = this.currentValue;
          textElement.classList.remove('placeholder');
        }
        
        if (this.onDisplayUpdate) {
          this.onDisplayUpdate(this.currentValue);
        }
      }
      
      enterEditMode() {
        this.displayElement.classList.add('hidden');
        this.editElement.classList.remove('hidden');
        this.inputElement.value = this.currentValue;
        this.inputElement.focus();
        this.inputElement.select();
        this.isDirty = false;
      }
      
      exitEditMode() {
        this.displayElement.classList.remove('hidden');
        this.editElement.classList.add('hidden');
        this.isDirty = false;
      }
      
      handleBlur() {
        // If value hasn't changed, exit edit mode
        if (!this.isDirty) {
          this.exitEditMode();
        }
        // If value has changed (dirty), stay in edit mode - user must explicitly save/cancel
      }
      
      handleKeydown(e) {
        if (e.key === 'Enter' && !this.isTextarea) {
          e.preventDefault();
          this.save();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          this.cancel();
        } else if (e.key === 'Tab') {
          // Allow tab navigation, but mark as dirty if value changed
          this.checkDirty();
        } else {
          // Mark as dirty on any input change
          setTimeout(() => this.checkDirty(), 0);
        }
      }
      
      checkDirty() {
        const newValue = this.inputElement.value.trim();
        this.isDirty = newValue !== this.originalValue;
      }
      
      save() {
        const newValue = this.inputElement.value.trim();
        this.currentValue = newValue;
        this.updateDisplay();
        this.exitEditMode();
        
        if (this.onSave) {
          this.onSave(newValue);
        }
      }
      
      cancel() {
        this.currentValue = this.originalValue;
        this.updateDisplay();
        this.exitEditMode();
        
        if (this.onCancel) {
          this.onCancel();
        }
      }
    }

    // Create editable field instances
    let titleField, descriptionField;

    // Utility functions for creating pill components
    function createTypeBadge(type) {
      const badge = document.createElement('span');
      badge.className = `type-badge ${type || 'task'}`;
      badge.textContent = type || 'Task';
      return badge;
    }

    function createStatusPill(status, displayText = null) {
      const pill = document.createElement('span');
      const displayStatus = status || 'open';
      const text = displayText || (displayStatus === 'in_progress' ? 'In Progress' :
        (displayStatus.charAt(0).toUpperCase() + displayStatus.slice(1)));
      pill.className = `subtask-status ${displayStatus}`;
      pill.textContent = text;
      return pill;
    }

    function createPriorityPill(priority) {
      const pill = document.createElement('span');
      const displayPriority = priority || 'medium';
      pill.className = `subtask-priority ${displayPriority}`;
      pill.textContent = displayPriority.charAt(0).toUpperCase() + displayPriority.slice(1);
      return pill;
    }

    function createDependencyStatusPill(status, displayText = null) {
      const pill = document.createElement('span');
      const displayStatus = status || 'open';
      const text = displayText || (displayStatus === 'in_progress' ? 'In Progress' :
        (displayStatus.charAt(0).toUpperCase() + displayStatus.slice(1)));
      pill.className = `dependency-status ${displayStatus}`;
      pill.textContent = text;
      return pill;
    }

    function createDependencyPriorityPill(priority) {
      const pill = document.createElement('span');
      const displayPriority = priority || 'medium';
      pill.className = `dependency-priority ${displayPriority}`;
      pill.textContent = displayPriority.charAt(0).toUpperCase() + displayPriority.slice(1);
      return pill;
    }

    function createCalendarIcon() {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('viewBox', '0 0 24 24');
      svg.setAttribute('fill', 'none');
      svg.setAttribute('width', '18');
      svg.setAttribute('height', '18');
      svg.style.marginRight = '4px';
      svg.style.flexShrink = '0';
      
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', 'M3 9H21M7 3V5M17 3V5M6 12H10V16H6V12ZM6.2 21H17.8C18.9201 21 19.4802 21 19.908 20.782C20.2843 20.5903 20.5903 20.2843 20.782 19.908C21 19.4802 21 18.9201 21 17.8V8.2C21 7.07989 21 6.51984 20.782 6.09202C20.5903 5.71569 20.2843 5.40973 19.908 5.21799C19.4802 5 18.9201 5 17.8 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V17.8C3 18.9201 3 19.4802 3.21799 19.908C3.40973 20.2843 3.71569 20.5903 4.09202 20.782C4.51984 21 5.07989 21 6.2 21Z');
      path.setAttribute('stroke', 'currentColor');
      path.setAttribute('stroke-width', '2');
      path.setAttribute('stroke-linecap', 'round');
      path.setAttribute('stroke-linejoin', 'round');
      
      svg.appendChild(path);
      return svg;
    }

    function setDateWithIcon(elementId, isoString) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      // Clear existing content
      element.innerHTML = '';
      
      // Add calendar icon
      const icon = createCalendarIcon();
      element.appendChild(icon);
      
      // Add date text
      const textNode = document.createTextNode(formatDate(isoString));
      element.appendChild(textNode);
    }

    // Notify extension that webview is ready
    vscode.postMessage({ type: 'webviewReady' });
    console.log('Webview ready message sent');

    window.addEventListener('message', event => {
      const message = event.data;
      console.log('Webview received message:', message);
      if (message.type === 'loadTicket') {
        ticketId = message.ticket.id;
        currentTitle = message.ticket.title || '';
        currentDescription = message.ticket.description || '';
        comments = message.ticket.comments || [];
        console.log('Loaded ticket:', ticketId, 'title:', currentTitle, 'desc:', currentDescription);
        document.getElementById('type').value = message.ticket.type || 'task';
        document.getElementById('priority').value = message.ticket.priority || 'medium';
        document.getElementById('status').value = message.ticket.status || 'open';
        subtasks = message.ticket.subtasks || [];
        dependencies = message.ticket.dependencies || [];
        
        // Update closed date display based on status
        onStatusChange();
        
        // Populate metadata
        document.getElementById('ticketId').textContent = message.ticket.id;
        setDateWithIcon('createdDate', message.ticket.created_at);
        setDateWithIcon('updatedDate', message.ticket.updated_at);
        
        const closedContainer = document.getElementById('closedDateContainer');
        const closedDateEl = document.getElementById('closedDate');
        if (message.ticket.closed_at) {
          closedContainer.style.display = 'block';
          setDateWithIcon('closedDate', message.ticket.closed_at);
        } else {
          closedContainer.style.display = 'none';
        }
        
        // Initialize editable fields
        if (!titleField) {
          titleField = new EditableField({
            fieldName: 'title',
            placeholder: 'Click to add title...',
            isTextarea: false,
            onSave: (value) => {
              currentTitle = value;
              saveTicket();
            },
            onCancel: () => {
              // Cancel handled automatically
            },
            onDisplayUpdate: (value) => {
              // Update display handled automatically
            }
          });
          document.getElementById('titleContainer').appendChild(titleField.getElement());
        }
        titleField.setValue(currentTitle);
        
        if (!descriptionField) {
          try {
            descriptionField = new EditableField({
              fieldName: 'description',
              placeholder: 'Click to add description...',
              isTextarea: true,
              onSave: (value) => {
                currentDescription = value;
                saveTicket();
              },
              onCancel: () => {
                // Cancel handled automatically
              },
              onDisplayUpdate: (value) => {
                // Update display handled automatically
              }
            });
            const descContainer = document.getElementById('descriptionContainer');
            console.log('Description container found:', !!descContainer);
            if (descContainer) {
              const element = descriptionField.getElement();
              console.log('Description element to append:', element);
              descContainer.appendChild(element);
              console.log('Description element appended');
            } else {
              console.error('Description container not found');
            }
          } catch (error) {
            console.error('Error creating description field:', error);
          }
        }
        try {
          descriptionField.setValue(currentDescription);
        } catch (error) {
          console.error('Error setting description value:', error);
        }
        
        renderComments();
        renderSubtasks();
        renderDependencies();
      } else if (message.type === 'availableSubtasks') {
        availableSubtasks = message.subtasks;
        renderAvailableSubtasks();
        document.getElementById('subtaskModal').classList.remove('hidden');
        document.getElementById('subtaskSearch').focus();
      } else if (message.type === 'availableDependencies') {
        availableDependencies = message.dependencies;
        renderAvailableDependencies();
        document.getElementById('dependencyModal').classList.remove('hidden');
        document.getElementById('dependencySearch').focus();
      } else if (message.type === 'commentAdded') {
        comments.push(message.comment);
        renderComments();
      }
    });

    function saveTicket() {
      console.log('Saving ticket, ticketId:', ticketId, 'title:', currentTitle, 'desc:', currentDescription);
      const ticket = {
        id: ticketId,
        title: currentTitle,
        description: currentDescription,
        comments: comments,
        type: document.getElementById('type').value,
        priority: document.getElementById('priority').value,
        status: document.getElementById('status').value,
        subtasks: subtasks,
        dependencies: dependencies
      };
      console.log('Sending saveTicket message:', ticket);
      vscode.postMessage({ type: 'saveTicket', ticket });
    }

    function renderSubtasks() {
      const list = document.getElementById('subtasksList');
      list.innerHTML = '';
      subtasks.forEach((subtask, index) => {
        const div = document.createElement('div');
        div.className = 'subtask';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'subtask-info';

        const typeBadge = createTypeBadge(subtask.type);
        const titleSpan = document.createElement('span');
        titleSpan.className = 'subtask-title';
        titleSpan.textContent = subtask.title;
        const idSpan = document.createElement('span');
        idSpan.className = 'subtask-id';
        idSpan.textContent = subtask.id;

        infoDiv.appendChild(typeBadge);
        infoDiv.appendChild(titleSpan);
        infoDiv.appendChild(idSpan);

        const statusPill = createStatusPill(subtask.status);
        const priorityPill = createPriorityPill(subtask.priority);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'secondary';
        removeBtn.textContent = 'Remove';
        removeBtn.onclick = () => removeSubtask(index);

        div.appendChild(infoDiv);
        div.appendChild(statusPill);
        div.appendChild(priorityPill);
        div.appendChild(removeBtn);

        list.appendChild(div);
      });
    }

    function renderDependencies() {
      const blockedByList = document.getElementById('blockedByList');
      const blockingList = document.getElementById('blockingList');
      blockedByList.innerHTML = '';
      blockingList.innerHTML = '';

      dependencies.forEach((dep, index) => {
        const div = document.createElement('div');
        div.className = 'dependency';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'dependency-info';

        const typeBadge = createTypeBadge(dep.type);
        const titleSpan = document.createElement('span');
        titleSpan.className = 'dependency-title';
        titleSpan.textContent = dep.title;
        const idSpan = document.createElement('span');
        idSpan.className = 'dependency-id';
        idSpan.textContent = dep.id;

        infoDiv.appendChild(typeBadge);
        infoDiv.appendChild(titleSpan);
        infoDiv.appendChild(idSpan);

        const statusPill = createDependencyStatusPill(dep.status);
        const priorityPill = createDependencyPriorityPill(dep.priority);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'secondary';
        removeBtn.textContent = 'Remove';
        removeBtn.onclick = () => removeDependency(index);

        div.appendChild(infoDiv);
        div.appendChild(statusPill);
        div.appendChild(priorityPill);
        div.appendChild(removeBtn);

        if (dep.direction === 'blocks') {
          blockedByList.appendChild(div);
        } else {
          blockingList.appendChild(div);
        }
      });
    }

    function removeSubtask(index) {
      subtasks.splice(index, 1);
      renderSubtasks();
      saveTicket();
    }

    function removeDependency(index) {
      dependencies.splice(index, 1);
      renderDependencies();
      saveTicket();
    }

    document.getElementById('addSubtask').addEventListener('click', () => {
      vscode.postMessage({ type: 'getAvailableSubtasks' });
    });

    document.getElementById('addDependency').addEventListener('click', () => {
      vscode.postMessage({ type: 'getAvailableDependencies' });
    });

    document.getElementById('ticketForm').addEventListener('submit', (e) => {
      e.preventDefault();
    });

    // Modal handlers
    document.getElementById('cancelSubtaskSelection').addEventListener('click', () => {
      document.getElementById('subtaskModal').classList.add('hidden');
      selectedSubtaskIds.clear();
      document.getElementById('subtaskSearch').value = '';
    });

    document.getElementById('confirmSubtaskSelection').addEventListener('click', () => {
      if (selectedSubtaskIds.size > 0) {
        const selectedSubtasks = availableSubtasks.filter(s => selectedSubtaskIds.has(s.id));
        selectedSubtasks.forEach(selectedSubtask => {
          subtasks.push({ id: selectedSubtask.id, title: selectedSubtask.title });
        });
        renderSubtasks();
        saveTicket();
      }
      document.getElementById('subtaskModal').classList.add('hidden');
      selectedSubtaskIds.clear();
      document.getElementById('subtaskSearch').value = '';
    });

    document.getElementById('subtaskSearch').addEventListener('input', (e) => {
      renderAvailableSubtasks(e.target.value);
    });

    function renderAvailableSubtasks(searchTerm = '') {
      const list = document.getElementById('availableSubtasks');
      list.innerHTML = '';

      const filtered = availableSubtasks
        .map(subtask => {
          const searchText = `${subtask.id} ${subtask.title} ${subtask.description}`.toLowerCase();
          const term = searchTerm.toLowerCase();
          let score = 0;

          if (searchText.includes(term)) {
            // Exact ID match gets highest score
            if (subtask.id.toLowerCase().includes(term)) score += 100;
            // Title match
            if (subtask.title.toLowerCase().includes(term)) score += 50;
            // Description match
            if (subtask.description.toLowerCase().includes(term)) score += 25;
            // Word boundaries get bonus
            if (new RegExp(`\\b${term}\\b`, 'i').test(searchText)) score += 10;
          }

          return { ...subtask, score };
        })
        .filter(subtask => subtask.score > 0 || !searchTerm)
        .sort((a, b) => b.score - a.score);

      filtered.forEach(subtask => {
        const div = document.createElement('div');
        div.className = `subtask-item ${selectedSubtaskIds.has(subtask.id) ? 'selected' : ''}`;

        // Checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'subtask-checkbox';
        checkbox.checked = selectedSubtaskIds.has(subtask.id);
        checkbox.onclick = (e) => {
          e.stopPropagation();
          e.preventDefault();
          toggleSubtaskSelection(subtask.id);
          // Update checkbox state manually since we prevented default
          checkbox.checked = selectedSubtaskIds.has(subtask.id);
        };

        // Content container
        const contentDiv = document.createElement('div');
        contentDiv.className = 'subtask-content';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'subtask-info';

        const typeBadge = createTypeBadge(subtask.type);
        const titleSpan = document.createElement('span');
        titleSpan.className = 'subtask-title';
        titleSpan.textContent = subtask.title;
        const idSpan = document.createElement('span');
        idSpan.className = 'subtask-id';
        idSpan.textContent = subtask.id;

        infoDiv.appendChild(typeBadge);
        infoDiv.appendChild(titleSpan);
        infoDiv.appendChild(idSpan);

        const statusPill = createStatusPill(subtask.status);
        const priorityPill = createPriorityPill(subtask.priority);

        contentDiv.appendChild(infoDiv);
        contentDiv.appendChild(statusPill);
        contentDiv.appendChild(priorityPill);

        // Row click handler (selects only this item)
        div.onclick = () => selectSingleSubtask(subtask.id);

        div.appendChild(checkbox);
        div.appendChild(contentDiv);

        list.appendChild(div);
      });

      // Update modal title to show selection count
      updateModalTitle();
    }

    function selectSingleSubtask(id) {
      selectedSubtaskIds.clear();
      selectedSubtaskIds.add(id);
      renderAvailableSubtasks(document.getElementById('subtaskSearch').value);
    }

    function toggleSubtaskSelection(id) {
      if (selectedSubtaskIds.has(id)) {
        selectedSubtaskIds.delete(id);
      } else {
        selectedSubtaskIds.add(id);
      }
      renderAvailableSubtasks(document.getElementById('subtaskSearch').value);
    }

    function updateModalTitle() {
      const titleEl = document.querySelector('.modal-title');
      const count = selectedSubtaskIds.size;
      if (count === 0) {
        titleEl.textContent = 'Select Subtasks';
      } else if (count === 1) {
        titleEl.textContent = 'Select Subtasks (1 selected)';
      } else {
        titleEl.textContent = `Select Subtasks (${count} selected)`;
      }
    }

    // Dependency modal handlers
    document.getElementById('cancelDependencySelection').addEventListener('click', () => {
      document.getElementById('dependencyModal').classList.add('hidden');
      selectedDependencyIds.clear();
      document.getElementById('dependencySearch').value = '';
    });

    document.getElementById('confirmDependencySelection').addEventListener('click', () => {
      const direction = document.querySelector('input[name="dependencyDirection"]:checked').value;
      if (selectedDependencyIds.size > 0) {
        const selectedDeps = availableDependencies.filter(d => selectedDependencyIds.has(d.id));
        selectedDeps.forEach(selectedDep => {
          dependencies.push({
            id: selectedDep.id,
            title: selectedDep.title,
            type: selectedDep.type,
            status: selectedDep.status,
            priority: selectedDep.priority,
            direction: direction
          });
        });
        renderDependencies();
        saveTicket();
      }
      document.getElementById('dependencyModal').classList.add('hidden');
      selectedDependencyIds.clear();
      document.getElementById('dependencySearch').value = '';
    });

    document.getElementById('dependencySearch').addEventListener('input', (e) => {
      renderAvailableDependencies(e.target.value);
    });

    function renderAvailableDependencies(searchTerm = '') {
      const list = document.getElementById('availableDependencies');
      list.innerHTML = '';

      const filtered = availableDependencies
        .map(dep => {
          const searchText = `${dep.id} ${dep.title} ${dep.description}`.toLowerCase();
          const term = searchTerm.toLowerCase();
          let score = 0;

          if (searchText.includes(term)) {
            // Exact ID match gets highest score
            if (dep.id.toLowerCase().includes(term)) score += 100;
            // Title match
            if (dep.title.toLowerCase().includes(term)) score += 50;
            // Description match
            if (dep.description.toLowerCase().includes(term)) score += 25;
            // Word boundaries get bonus
            if (new RegExp(`\\b${term}\\b`, 'i').test(searchText)) score += 10;
          }

          return { ...dep, score };
        })
        .filter(dep => dep.score > 0 || !searchTerm)
        .sort((a, b) => b.score - a.score);

      filtered.forEach(dep => {
        const div = document.createElement('div');
        div.className = `dependency-item ${selectedDependencyIds.has(dep.id) ? 'selected' : ''}`;

        // Checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'dependency-checkbox';
        checkbox.checked = selectedDependencyIds.has(dep.id);
        checkbox.onclick = (e) => {
          e.stopPropagation();
          e.preventDefault();
          toggleDependencySelection(dep.id);
          // Update checkbox state manually since we prevented default
          checkbox.checked = selectedDependencyIds.has(dep.id);
        };

        // Content container
        const contentDiv = document.createElement('div');
        contentDiv.className = 'dependency-content';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'dependency-info';

        const typeBadge = createTypeBadge(dep.type);
        const titleSpan = document.createElement('span');
        titleSpan.className = 'dependency-title';
        titleSpan.textContent = dep.title;
        const idSpan = document.createElement('span');
        idSpan.className = 'dependency-id';
        idSpan.textContent = dep.id;

        infoDiv.appendChild(typeBadge);
        infoDiv.appendChild(titleSpan);
        infoDiv.appendChild(idSpan);

        const statusPill = createDependencyStatusPill(dep.status);
        const priorityPill = createDependencyPriorityPill(dep.priority);

        contentDiv.appendChild(infoDiv);
        contentDiv.appendChild(statusPill);
        contentDiv.appendChild(priorityPill);

        // Row click handler (selects only this item)
        div.onclick = () => selectSingleDependency(dep.id);

        div.appendChild(checkbox);
        div.appendChild(contentDiv);

        list.appendChild(div);
      });

      // Update modal title to show selection count
      updateDependencyModalTitle();
    }

    function selectSingleDependency(id) {
      selectedDependencyIds.clear();
      selectedDependencyIds.add(id);
      renderAvailableDependencies(document.getElementById('dependencySearch').value);
    }

    function toggleDependencySelection(id) {
      if (selectedDependencyIds.has(id)) {
        selectedDependencyIds.delete(id);
      } else {
        selectedDependencyIds.add(id);
      }
      renderAvailableDependencies(document.getElementById('dependencySearch').value);
    }

    function updateDependencyModalTitle() {
      const titleEl = document.querySelector('#dependencyModal .modal-title');
      const count = selectedDependencyIds.size;
      if (count === 0) {
        titleEl.textContent = 'Select Dependencies';
      } else if (count === 1) {
        titleEl.textContent = 'Select Dependencies (1 selected)';
      } else {
        titleEl.textContent = `Select Dependencies (${count} selected)`;
      }
    }

    // Comment thread functions
    function renderComments() {
      const thread = document.getElementById('commentsThread');
      thread.innerHTML = '';

      if (!comments || comments.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'comments-empty';
        empty.textContent = 'No comments yet. Add a comment below to start the conversation.';
        thread.appendChild(empty);
        return;
      }

      comments.forEach(comment => {
        const item = document.createElement('div');
        item.className = 'comment-item';

        const header = document.createElement('div');
        header.className = 'comment-header';

        const author = document.createElement('span');
        const isAgent = comment.author === 'agent' || comment.author === 'developer';
        author.className = `comment-author ${isAgent ? 'agent' : ''}`;
        author.textContent = isAgent ? 'Agent' : comment.author;

        const timestamp = document.createElement('span');
        timestamp.className = 'comment-timestamp';
        timestamp.textContent = formatTimestamp(comment.created_at);

        header.appendChild(author);
        header.appendChild(document.createTextNode('‚Ä¢'));
        header.appendChild(timestamp);

        const content = document.createElement('div');
        content.className = 'comment-content';
        content.textContent = comment.content;

        item.appendChild(header);
        item.appendChild(content);
        thread.appendChild(item);
      });
    }

    function formatDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatTimestamp(isoString) {
      const date = new Date(isoString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins} min${diffMins === 1 ? '' : 's'} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
      return date.toLocaleDateString();
    }

    function onStatusChange() {
      const status = document.getElementById('status').value;
      const closedContainer = document.getElementById('closedDateContainer');
      const closedDateEl = document.getElementById('closedDate');
      
      if (status === 'closed') {
        closedContainer.style.display = 'block';
        setDateWithIcon('closedDate', new Date().toISOString());
      } else {
        closedContainer.style.display = 'none';
      }
    }

    document.getElementById('addCommentBtn').addEventListener('click', () => {
      const input = document.getElementById('commentInput');
      const authorInput = document.getElementById('commentAuthor');
      const content = input.value.trim();
      const author = authorInput.value.trim() || 'user';

      if (!content) return;

      // Send message to extension to add comment
      vscode.postMessage({
        type: 'addComment',
        issueId: ticketId,
        author: author,
        content: content
      });

      // Clear input
      input.value = '';
    });

    // Delete functionality
    let deleteConfirmPopup = null;

    document.getElementById('deleteTicket').addEventListener('click', function (e) {
      const button = e.target;

      // Close any existing popup
      if (deleteConfirmPopup) {
        deleteConfirmPopup.remove();
        deleteConfirmPopup = null;
        return;
      }

      // Create popup
      const popup = document.createElement('div');
      popup.className = 'delete-confirm-popup visible';

      const childCount = subtasks.length;

      const textEl = document.createElement('div');
      textEl.className = 'delete-confirm-text';
      if (childCount > 0) {
        textEl.innerHTML = `Delete <strong>${currentTitle}</strong>?<br><br>This will unparent ${childCount} subtask${childCount === 1 ? '' : 's'}.`;
      } else {
        textEl.innerHTML = `Delete <strong>${currentTitle}</strong>?`;
      }

      const buttonsEl = document.createElement('div');
      buttonsEl.className = 'delete-confirm-buttons';

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'delete-confirm-btn cancel';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.onclick = () => {
        popup.remove();
        deleteConfirmPopup = null;
      };

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-confirm-btn delete';
      deleteBtn.textContent = 'Delete';
      deleteBtn.onclick = () => {
        popup.remove();
        deleteConfirmPopup = null;
        vscode.postMessage({ type: 'deleteTask', id: ticketId });
      };

      buttonsEl.appendChild(cancelBtn);
      buttonsEl.appendChild(deleteBtn);

      popup.appendChild(textEl);
      popup.appendChild(buttonsEl);

      // Position popup relative to button
      document.body.appendChild(popup);
      const buttonRect = button.getBoundingClientRect();
      popup.style.position = 'fixed';
      popup.style.top = `${buttonRect.top - popup.offsetHeight - 4}px`;
      popup.style.left = `${buttonRect.left}px`;

      deleteConfirmPopup = popup;

      // Close popup when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closePopup(e) {
          if (popup && !popup.contains(e.target) && e.target !== button) {
            popup.remove();
            deleteConfirmPopup = null;
            document.removeEventListener('click', closePopup);
          }
        });
      }, 0);
    });

    function formatDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
  </script>
</body>

</html>