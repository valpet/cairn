<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Ticket</title>
  <style>
    body {
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      color: var(--vscode-foreground);
      background-color: var(--vscode-editor-background);
      margin: 0;
      padding: 20px;
    }

    h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 24px 0;
    }

    h3 {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 0 0;
    }

    .editor-layout {
      display: flex;
      gap: 24px;
      align-items: stretch;
    }

    .main-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .metadata-card {
      width: 280px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }

    .metadata-card .collapsible-content {
      background-color: rgba(0, 0, 0, 0.08);
    }

    .metadata-card .collapsible-header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }

    .metadata-item {
      margin-bottom: 12px;
    }

    .metadata-item:last-child {
      margin-bottom: 0;
    }

    .metadata-label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: var(--vscode-descriptionForeground);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .metadata-value {
      color: var(--vscode-editor-foreground);
    }

    .metadata-value select {
      width: 100%;
      padding: 4px 6px;
      font-size: 13px;
      border: 1px solid var(--vscode-input-border, transparent);
      border-radius: 3px;
      background-color: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      outline: none;
    }

    .metadata-value select:focus {
      border-color: var(--vscode-focusBorder);
      outline: 1px solid var(--vscode-focusBorder);
      outline-offset: -1px;
    }

    .metadata-value.date-value {
      color: var(--vscode-editor-foreground);
      display: flex;
      align-items: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 500;
    }

    .editable-field {
      position: relative;
    }

    .field-display {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 6px 8px;
      min-height: 32px;
      border: 1px solid transparent;
      border-radius: 2px;
      cursor: pointer;
    }

    .field-display:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .field-text {
      flex: 1;
      word-wrap: break-word;
      white-space: pre-wrap;
      color: var(--vscode-editor-foreground);
      font-weight: 500;
      font-size: 14px;
    }

    .field-text.placeholder {
      color: var(--vscode-input-placeholderForeground);
      font-style: italic;
      font-weight: 400;
    }

    .edit-icon {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
      opacity: 0.6;
    }

    .edit-icon:hover {
      opacity: 1;
    }

    .field-edit {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .field-edit input,
    .field-edit textarea {
      flex: 1;
    }

    .edit-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .icon-button {
      width: 28px;
      height: 28px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--vscode-button-border, transparent);
      border-radius: 2px;
      cursor: pointer;
    }

    .icon-button svg {
      width: 16px;
      height: 16px;
    }

    .icon-button.accept {
      color: var(--vscode-button-foreground);
      background-color: var(--vscode-button-background);
    }

    .icon-button.accept:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    .icon-button.cancel {
      color: var(--vscode-button-secondaryForeground);
      background-color: var(--vscode-button-secondaryBackground);
    }

    .icon-button.cancel:hover {
      background-color: var(--vscode-button-secondaryHoverBackground);
    }

    .icon-button.remove {
      color: var(--vscode-foreground);
      background-color: transparent;
      border: 1px solid transparent;
      opacity: 0.6;
    }

    .icon-button.remove:hover {
      opacity: 1;
      background-color: var(--vscode-list-hoverBackground);
    }

    .hidden {
      display: none !important;
    }

    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 6px 8px;
      box-sizing: border-box;
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      color: var(--vscode-input-foreground);
      background-color: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border, transparent);
      outline: none;
      border-radius: 2px;
    }

    input[type="text"]:focus,
    select:focus,
    textarea:focus {
      border-color: var(--vscode-focusBorder);
      outline: 1px solid var(--vscode-focusBorder);
      outline-offset: -1px;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    button {
      padding: 6px 14px;
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      color: var(--vscode-button-foreground);
      background-color: var(--vscode-button-background);
      border: none;
      border-radius: 2px;
      cursor: pointer;
      outline: none;
    }

    button:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    button:focus {
      outline: 1px solid var(--vscode-focusBorder);
      outline-offset: 2px;
    }

    button.secondary {
      color: var(--vscode-button-secondaryForeground);
      background-color: var(--vscode-button-secondaryBackground);
    }

    button.secondary:hover {
      background-color: var(--vscode-button-secondaryHoverBackground);
    }

    .subtasks-section .collapsible-content {
      background-color: rgba(0, 0, 0, 0.08);
    }

    .subtask-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .subtask {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid var(--vscode-list-inactiveSelectionBackground);
      border-radius: 3px;
      margin-bottom: 4px;
    }

    .subtask-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dependencies-section .collapsible-content {
      background-color: rgba(0, 0, 0, 0.08);
    }

    .collapsible-section {
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
    }

    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      padding: 12px 16px;
      background-color: rgba(0, 0, 0, 0.08);
      border: 1px solid var(--vscode-widget-border);
      border-radius: 4px;
    }

    .collapsible-header:hover {
      background-color: rgba(0, 0, 0, 0.12);
    }

    .collapsible-header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      flex-grow: 1;
    }

    .collapsible-caret {
      width: 16px;
      height: 16px;
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }

    .collapsible-header.collapsed .collapsible-caret {
      transform: rotate(-90deg);
    }

    .collapsible-body {
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .collapsible-body.collapsed {
      max-height: 0 !important;
    }

    .collapsible-content {
      padding: 16px;
      border: 1px solid var(--vscode-widget-border);
      border-top: none;
      border-radius: 0 0 4px 4px;
    }

    .title-description-section .collapsible-content {
      background-color: rgba(0, 0, 0, 0.08);
    }

    .title-description-section h3 {
      margin: 0 0 0 0;
      font-size: 14px;
      font-weight: 600;
    }

    .dependency-section {
      margin-bottom: 16px;
    }

    .dependency-section h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .dependency-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .dependency {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid var(--vscode-list-inactiveSelectionBackground);
      border-radius: 3px;
      margin-bottom: 4px;
    }

    .dependency-direction {
      font-size: 14px;
      font-weight: bold;
      color: var(--vscode-descriptionForeground);
      min-width: 20px;
    }

    .dependency-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dependency-type,
    .dependency-status,
    .dependency-priority {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      display: inline-block;
      text-transform: capitalize;
    }

    .dependency-type {
      background-color: var(--vscode-badge-background);
      color: var(--vscode-badge-foreground);
    }

    .dependency-status.open {
      background-color: rgba(46, 160, 67, 0.2);
      color: #3fb950;
    }

    .dependency-status.in_progress {
      background-color: rgba(68, 131, 255, 0.2);
      color: #58a6ff;
    }

    .dependency-status.closed {
      background-color: rgba(139, 148, 158, 0.2);
      color: #8b949e;
    }

    .dependency-status.blocked {
      background-color: rgba(218, 54, 51, 0.2);
      color: #f85149;
    }

    .dependency-priority.low {
      background-color: rgba(46, 160, 67, 0.2);
      color: #3fb950;
    }

    .dependency-priority.medium {
      background-color: rgba(212, 165, 86, 0.2);
      color: #D4A556;
    }

    .dependency-priority.high {
      background-color: rgba(251, 133, 0, 0.2);
      color: #fb8500;
    }

    .dependency-priority.urgent {
      background-color: rgba(218, 54, 51, 0.2);
      color: #f85149;
    }

    .dependency-title {
      flex: 1;
      font-weight: 600;
      color: var(--vscode-editor-foreground);
      font-size: 14px;
    }

    .dependency-id {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      font-family: monospace;
    }

    .dependency-list-modal {
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--vscode-widget-border);
      border-radius: 3px;
    }

    .dependency-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid var(--vscode-list-inactiveSelectionBackground);
      cursor: pointer;
    }

    .dependency-item:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .dependency-item.selected {
      background-color: var(--vscode-list-activeSelectionBackground);
    }

    .dependency-checkbox {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      flex-shrink: 0;
      accent-color: var(--vscode-button-background);
    }

    .dependency-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background-color: var(--vscode-quickInput-background);
      border: 1px solid var(--vscode-widget-border);
      border-radius: 6px;
      width: 90%;
      max-width: 600px;
      max-height: 80%;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--vscode-widget-border);
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .modal-body {
      padding: 16px;
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .search-input {
      width: 100%;
      margin-bottom: 12px;
      padding: 8px 12px;
      box-sizing: border-box;
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      color: var(--vscode-input-foreground);
      background-color: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border);
      border-radius: 3px;
      outline: none;
    }

    .search-input:focus {
      border-color: var(--vscode-focusBorder);
      outline: 1px solid var(--vscode-focusBorder);
      outline-offset: -1px;
    }

    .subtask-list-modal {
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--vscode-widget-border);
      border-radius: 3px;
    }

    .subtask-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid var(--vscode-list-inactiveSelectionBackground);
      cursor: pointer;
    }

    .subtask-item:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .subtask-item.selected {
      background-color: var(--vscode-list-activeSelectionBackground);
    }

    .subtask-checkbox {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      flex-shrink: 0;
      accent-color: var(--vscode-button-background);
    }

    .subtask-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .subtask-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .subtask-type,
    .subtask-status,
    .subtask-priority {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      display: inline-block;
      text-transform: capitalize;
    }

    .subtask-type {
      background-color: var(--vscode-badge-background);
      color: var(--vscode-badge-foreground);
    }

    .subtask-status.open {
      background-color: rgba(46, 160, 67, 0.2);
      color: #3fb950;
    }

    .subtask-status.in_progress {
      background-color: rgba(68, 131, 255, 0.2);
      color: #58a6ff;
    }

    .subtask-status.closed {
      background-color: rgba(139, 148, 158, 0.2);
      color: #8b949e;
    }

    .subtask-status.blocked {
      background-color: rgba(218, 54, 51, 0.2);
      color: #f85149;
    }

    .subtask-priority.low {
      background-color: rgba(46, 160, 67, 0.2);
      color: #3fb950;
    }

    .subtask-priority.medium {
      background-color: rgba(212, 165, 86, 0.2);
      color: #D4A556;
    }

    .subtask-priority.high {
      background-color: rgba(251, 133, 0, 0.2);
      color: #fb8500;
    }

    .subtask-priority.urgent {
      background-color: rgba(218, 54, 51, 0.2);
      color: #f85149;
    }

    .subtask-title {
      flex: 1;
      font-weight: 600;
      color: var(--vscode-editor-foreground);
      font-size: 14px;
    }

    .subtask-id {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      font-family: monospace;
    }

    .modal-footer {
      padding: 16px;
      border-top: 1px solid var(--vscode-widget-border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* Type badge styles (matching task list) */
    .type-badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
      height: 22px;
      line-height: 1;
    }

    .type-badge::before {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      line-height: 1;
    }

    .type-badge.epic {
      background-color: rgba(138, 98, 255, 0.2);
      color: #8A62FF;
    }

    .type-badge.epic::before {
      content: '‚ö°';
    }

    .type-badge.task {
      background-color: rgba(68, 131, 255, 0.2);
      color: #4483FF;
    }

    .type-badge.task::before {
      content: '‚Ä¢';
      font-size: 16px;
    }

    .type-badge.bug {
      background-color: rgba(218, 54, 51, 0.2);
      color: #f85149;
    }

    .type-badge.bug::before {
      content: 'üêõ';
      font-size: 11px;
    }

    .type-badge.feature {
      background-color: rgba(46, 160, 67, 0.2);
      color: #3fb950;
    }

    .type-badge.feature::before {
      content: '‚ú®';
      font-size: 11px;
    }

    .type-badge.chore {
      background-color: rgba(139, 148, 158, 0.2);
      color: #8b949e;
    }

    .type-badge.chore::before {
      content: 'üîß';
      font-size: 11px;
    }

    .type-badge.docs {
      background-color: rgba(88, 166, 255, 0.2);
      color: #58a6ff;
    }

    .type-badge.docs::before {
      content: 'üìù';
      font-size: 11px;
    }

    .type-badge.refactor {
      background-color: rgba(212, 165, 86, 0.2);
      color: #D4A556;
    }

    .type-badge.refactor::before {
      content: '‚ôªÔ∏è';
      font-size: 11px;
    }

    /* Delete button and confirmation popup */
    .delete-ticket-btn {
      background-color: #f85149;
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 2px;
      cursor: pointer;
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      margin-top: 20px;
      position: relative;
    }

    .delete-ticket-btn:hover {
      background-color: #da3633;
    }

    .delete-ticket-btn:focus {
      outline: 1px solid var(--vscode-focusBorder);
      outline-offset: 2px;
    }

    .delete-confirm-popup {
      position: absolute;
      background-color: var(--vscode-dropdown-background);
      border: 1px solid #f85149;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      padding: 12px;
      z-index: 2000;
      min-width: 220px;
      display: none;
    }

    .delete-confirm-popup.visible {
      display: block;
    }

    .delete-confirm-text {
      color: var(--vscode-foreground);
      font-size: 13px;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .delete-confirm-text strong {
      color: #f85149;
    }

    .delete-confirm-buttons {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .delete-confirm-btn {
      padding: 4px 12px;
      border: none;
      border-radius: 3px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s;
    }

    .delete-confirm-btn.delete {
      background-color: #f85149;
      color: white;
    }

    .delete-confirm-btn.delete:hover {
      background-color: #da3633;
    }

    .delete-confirm-btn.cancel {
      background-color: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
    }

    .delete-confirm-btn.cancel:hover {
      background-color: var(--vscode-button-secondaryHoverBackground);
    }

    /* Comments section */
    .comments-section .collapsible-content {
      background-color: rgba(0, 0, 0, 0.08);
    }

    .comments-header {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 600;
    }

    .comments-thread {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .comment-item {
      padding: 12px;
      background-color: var(--vscode-editor-background);
      border-radius: 4px;
      border-left: 3px solid var(--vscode-focusBorder);
    }

    .comment-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .comment-icon {
      width: 26px;
      height: 26px;
      flex-shrink: 0;
    }

    .comment-icon.agent-icon {
      width: 24px;
      height: 24px;
    }

    .comment-author {
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .comment-author.agent {
      color: #58a6ff;
    }

    .comment-timestamp {
      color: var(--vscode-descriptionForeground);
      font-size: 11px;
    }

    .comment-content {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 13px;
      line-height: 1.6;
      color: var(--vscode-editor-foreground);
    }

    .comments-empty {
      color: var(--vscode-input-placeholderForeground);
      font-style: italic;
      padding: 12px;
      text-align: center;
    }

    .add-comment-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-top: 1px solid var(--vscode-widget-border);
      padding-top: 12px;
    }

    .add-comment-header {
      display: flex;
      align-items: center;
      gap: 2px;
      margin-bottom: 8px;
    }

    .add-comment-header .user-icon {
      width: 26px;
      height: 26px;
      flex-shrink: 0;
    }

    .add-comment-header label {
      font-size: 13px;
      font-weight: 400;
      color: var(--vscode-descriptionForeground);
      white-space: nowrap;
      line-height: 20px;
      margin: 0;
    }

    .commenting-as-field {
      display: inline-flex;
      align-items: center;
    }

    .commenting-as-field .editable-field {
      display: inline-flex;
      align-items: center;
    }

    .commenting-as-field .field-display {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 0 6px;
      min-height: 20px;
      border-radius: 2px;
    }

    .commenting-as-field .field-text {
      font-size: 13px;
      font-weight: 500;
      line-height: 20px;
      margin: 0;
      padding: 0;
    }

    .commenting-as-field .edit-icon {
      width: 14px;
      height: 14px;
    }

    .task-id-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
    }

    .task-id {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .metadata-value .task-id {
      font-size: 13px;
      color: var(--vscode-editor-foreground);

    }

    .copy-id-btn svg {
      fill: var(--vscode-editor-foreground);
    }

    .copy-id-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 2px;
      border-radius: 2px;
      opacity: 0.6;
      transition: opacity 0.15s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .copy-id-btn:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.05);
    }

    .copy-id-btn svg {
      width: 12px;
      height: 12px;
      opacity: 0.8;
    }

    #commentInput {
      width: 100%;
      min-height: 80px;
      padding: 8px;
      font-family: var(--vscode-editor-font-family);
      font-size: 13px;
      resize: vertical;
    }

    .add-comment-actions {
      display: flex;
      justify-content: flex-end;
    }

    /* Acceptance Criteria section */
    .acceptance-criteria-section .collapsible-content {
      background-color: rgba(0, 0, 0, 0.08);
    }

    .acceptance-criteria-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .acceptance-criteria-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid var(--vscode-list-inactiveSelectionBackground);
      border-radius: 3px;
      background-color: var(--vscode-editor-background);
    }

    .acceptance-criteria-checkbox {
      width: 16px;
      height: 16px;
      margin-top: 2px;
      flex-shrink: 0;
      accent-color: var(--vscode-button-background);
    }

    .acceptance-criteria-content {
      flex: 1;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      min-width: 0;
      /* Allow text to shrink */
    }

    .acceptance-criteria-text-container {
      flex: 1;
      min-width: 0;
      /* Allow text to shrink */
    }

    .acceptance-criteria-text-container .editable-field .field-display {
      padding: 0;
      min-height: auto;
      border: none;
      background: transparent;
    }

    .acceptance-criteria-text-container .editable-field .field-display:hover {
      background-color: transparent;
    }

    .acceptance-criteria-text-container .editable-field .field-text {
      font-size: 13px;
      line-height: 1.4;
      margin: 0;
      padding: 2px 0;
    }

    .acceptance-criteria-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
      margin-left: auto;
    }
  </style>
</head>

<body>
  <h1>Edit Ticket</h1>
  <form id="ticketForm">
    <div class="editor-layout">
      <div class="main-content">
        <div class="title-description-section collapsible-section">
          <div class="collapsible-header" onclick="toggleSection(this)">
            <h3>Overview</h3>
            <svg class="collapsible-caret" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M4.427 7.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 7H4.604a.25.25 0 00-.177.427z" />
            </svg>
          </div>
          <div class="collapsible-body">
            <div class="collapsible-content">
              <div class="field-group">
                <label for="titleContainer">Title</label>
                <div id="titleContainer"></div>
              </div>
              <div class="field-group">
                <label for="descriptionContainer">Description</label>
                <div id="descriptionContainer"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="metadata-card collapsible-section">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <h3>Properties</h3>
          <svg class="collapsible-caret" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M4.427 7.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 7H4.604a.25.25 0 00-.177.427z" />
          </svg>
        </div>
        <div class="collapsible-body">
          <div class="collapsible-content">

            <div class="metadata-item">
              <label class="metadata-label">Type</label>
              <div class="metadata-value">
                <select id="type" onchange="saveTicket()">
                  <option value="task">Task</option>
                  <option value="bug">Bug</option>
                  <option value="feature">Feature</option>
                  <option value="epic">Epic</option>
                  <option value="chore">Chore</option>
                  <option value="docs">Docs</option>
                  <option value="refactor">Refactor</option>
                </select>
              </div>
            </div>

            <div class="metadata-item">
              <label class="metadata-label">Priority</label>
              <div class="metadata-value">
                <select id="priority" onchange="saveTicket()">
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
            </div>

            <div class="metadata-item">
              <label class="metadata-label">Status</label>
              <div class="metadata-value">
                <select id="status" onchange="onStatusChange(); saveTicket()">
                  <option value="open">Open</option>
                  <option value="in_progress">In Progress</option>
                  <option value="closed">Closed</option>
                  <option value="blocked">Blocked</option>
                </select>
              </div>
            </div>

            <div class="metadata-item">
              <label class="metadata-label">Created</label>
              <div class="metadata-value date-value" id="createdDate">-</div>
            </div>

            <div class="metadata-item">
              <label class="metadata-label">Updated</label>
              <div class="metadata-value date-value" id="updatedDate">-</div>
            </div>

            <div class="metadata-item" id="closedDateContainer" style="display: none;">
              <label class="metadata-label">Closed</label>
              <div class="metadata-value date-value" id="closedDate">-</div>
            </div>

            <div class="metadata-item">
              <label class="metadata-label">ID</label>
              <div class="metadata-value">
                <div class="task-id">
                  <span id="ticketId">-</span>
                  <button class="copy-id-btn" title="Copy ID to clipboard"
                    onclick="navigator.clipboard.writeText(document.getElementById('ticketId').textContent)">
                    <svg fill="#000000" viewBox="0 0 36 36" version="1.1" preserveAspectRatio="xMidYMid meet"
                      xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                      <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                      <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                      <g id="SVGRepo_iconCarrier">
                        <title>copy-to-clipboard-line</title>
                        <path
                          d="M22.6,4H21.55a3.89,3.89,0,0,0-7.31,0H13.4A2.41,2.41,0,0,0,11,6.4V10H25V6.4A2.41,2.41,0,0,0,22.6,4ZM23,8H13V6.25A.25.25,0,0,1,13.25,6h2.69l.12-1.11A1.24,1.24,0,0,1,16.61,4a2,2,0,0,1,3.15,1.18l.09.84h2.9a.25.25,0,0,1,.25.25Z"
                          class="clr-i-outline clr-i-outline-path-1"></path>
                        <path
                          d="M33.25,18.06H21.33l2.84-2.83a1,1,0,1,0-1.42-1.42L17.5,19.06l5.25,5.25a1,1,0,0,0,.71.29,1,1,0,0,0,.71-1.7l-2.84-2.84H33.25a1,1,0,0,0,0-2Z"
                          class="clr-i-outline clr-i-outline-path-2"></path>
                        <path d="M29,16h2V6.68A1.66,1.66,0,0,0,29.35,5H27.08V7H29Z"
                          class="clr-i-outline clr-i-outline-path-3"></path>
                        <path
                          d="M29,31H7V7H9V5H6.64A1.66,1.66,0,0,0,5,6.67V31.32A1.66,1.66,0,0,0,6.65,33H29.36A1.66,1.66,0,0,0,31,31.33V22.06H29Z"
                          class="clr-i-outline clr-i-outline-path-4"></path>
                        <rect x="0" y="0" width="36" height="36" fill-opacity="0"></rect>
                      </g>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="acceptance-criteria-section collapsible-section">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <h3>Acceptance Criteria</h3>
        <svg class="collapsible-caret" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M4.427 7.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 7H4.604a.25.25 0 00-.177.427z" />
        </svg>
      </div>
      <div class="collapsible-body">
        <div class="collapsible-content">
          <div id="acceptanceCriteriaList" class="acceptance-criteria-list"></div>
          <button type="button" id="addAcceptanceCriteria" class="secondary">Add Acceptance Criteria</button>
        </div>
      </div>
    </div>
    <div class="subtasks-section collapsible-section">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <h3>Sub-issues</h3>
        <svg class="collapsible-caret" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M4.427 7.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 7H4.604a.25.25 0 00-.177.427z" />
        </svg>
      </div>
      <div class="collapsible-body">
        <div class="collapsible-content">
          <div id="subtasksList" class="subtask-list"></div>
          <button type="button" id="addSubtask" class="secondary">Add Sub-issue</button>
        </div>
      </div>
    </div>
    <div class="dependencies-section collapsible-section">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <h3>Dependencies</h3>
        <svg class="collapsible-caret" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M4.427 7.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 7H4.604a.25.25 0 00-.177.427z" />
        </svg>
      </div>
      <div class="collapsible-body">
        <div class="collapsible-content">
          <div class="dependency-section">
            <h4>Blocked by</h4>
            <div id="blockedByList" class="dependency-list"></div>
          </div>
          <div class="dependency-section">
            <h4>This issue is blocking</h4>
            <div id="blockingList" class="dependency-list"></div>
          </div>
          <button type="button" id="addDependency" class="secondary">Add Dependency</button>
        </div>
      </div>
    </div>
    <div class="comments-section collapsible-section">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <h3 class="comments-header">Comments</h3>
        <svg class="collapsible-caret" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M4.427 7.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 7H4.604a.25.25 0 00-.177.427z" />
        </svg>
      </div>
      <div class="collapsible-body">
        <div class="collapsible-content">
          <div class="comments-thread" id="commentsThread">
            <div class="comments-empty">No comments yet. Add a comment below to start the conversation.</div>
          </div>
          <div class="add-comment-form">
            <div class="add-comment-header">
              <svg class="user-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.2" />
                <path
                  d="M16.807 19.0112C15.4398 19.9504 13.7841 20.5 12 20.5C10.2159 20.5 8.56023 19.9503 7.193 19.0111C6.58915 18.5963 6.33109 17.8062 6.68219 17.1632C7.41001 15.8302 8.90973 15 12 15C15.0903 15 16.59 15.8303 17.3178 17.1632C17.6689 17.8062 17.4108 18.5964 16.807 19.0112Z"
                  fill="currentColor" />
                <path
                  d="M12 12C13.6569 12 15 10.6569 15 9C15 7.34315 13.6569 6 12 6C10.3432 6 9.00004 7.34315 9.00004 9C9.00004 10.6569 10.3432 12 12 12Z"
                  fill="currentColor" />
              </svg>
              <label>Commenting as:</label>
              <div id="commentAuthorContainer" class="commenting-as-field"></div>
            </div>
            <textarea id="commentInput" placeholder="Add a comment..."></textarea>
            <div class="add-comment-actions">
              <button type="button" id="addCommentBtn">Add Comment</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <button type="button" id="deleteTicket" class="delete-ticket-btn">Delete Ticket</button>
  </form>

  <!-- Subtask Selection Modal -->
  <div id="subtaskModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Select Subtask</h2>
      </div>
      <div class="modal-body">
        <input type="text" id="subtaskSearch" class="search-input"
          placeholder="Search by ID, title, or description..." />
        <div id="availableSubtasks" class="subtask-list-modal"></div>
      </div>
      <div class="modal-footer">
        <button type="button" id="cancelSubtaskSelection" class="secondary">Cancel</button>
        <button type="button" id="confirmSubtaskSelection">Add Selected Subtasks</button>
      </div>
    </div>
  </div>

  <!-- Dependency Selection Modal -->
  <div id="dependencyModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Select Dependencies</h2>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 12px;">
          <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500;">Dependency
            Direction:</label>
          <div style="display: flex; gap: 16px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
              <input type="radio" name="dependencyDirection" value="blocks" checked>
              This task depends on selected tasks (Blocked by)
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
              <input type="radio" name="dependencyDirection" value="blocked_by">
              Selected tasks depend on this task (Blocking)
            </label>
          </div>
        </div>
        <input type="text" id="dependencySearch" class="search-input"
          placeholder="Search by ID, title, or description..." />
        <div id="availableDependencies" class="dependency-list-modal"></div>
      </div>
      <div class="modal-footer">
        <button type="button" id="cancelDependencySelection" class="secondary">Cancel</button>
        <button type="button" id="confirmDependencySelection">Add Selected Dependencies</button>
      </div>
    </div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();
    let ticketId = null;
    let subtasks = [];
    let dependencies = [];
    let currentTitle = '';
    let currentDescription = '';
    let comments = [];
    let availableSubtasks = [];
    let selectedSubtaskIds = new Set();
    let availableDependencies = [];
    let selectedDependencyIds = new Set();
    let acceptanceCriteria = [];

    // Toggle section collapse/expand
    function toggleSection(header) {
      header.classList.toggle('collapsed');
      const body = header.nextElementSibling;
      body.classList.toggle('collapsed');

      if (!body.classList.contains('collapsed')) {
        body.style.maxHeight = body.scrollHeight + 'px';
      }
    }

    // Initialize all sections as expanded
    function initializeSections() {
      document.querySelectorAll('.collapsible-body').forEach(body => {
        body.style.maxHeight = body.scrollHeight + 'px';
      });
    }

    // Reusable EditableField component
    class EditableField {
      constructor(options) {
        this.fieldName = options.fieldName;
        this.placeholder = options.placeholder || 'Click to edit...';
        this.isTextarea = options.isTextarea || false;
        this.onSave = options.onSave;
        this.onCancel = options.onCancel;
        this.onDisplayUpdate = options.onDisplayUpdate;

        this.container = null;
        this.displayElement = null;
        this.editElement = null;
        this.inputElement = null;
        this.originalValue = '';
        this.currentValue = '';
        this.isDirty = false;

        this.init();
      }

      init() {
        // Create container
        this.container = document.createElement('div');
        this.container.className = 'editable-field';

        // Create display element
        this.displayElement = document.createElement('div');
        this.displayElement.className = 'field-display';
        this.displayElement.onclick = () => this.enterEditMode();

        const textElement = document.createElement('div');
        textElement.className = 'field-text';
        this.displayElement.appendChild(textElement);

        const icon = document.createElement('svg');
        icon.className = 'edit-icon';
        icon.setAttribute('viewBox', '0 0 16 16');
        icon.setAttribute('fill', 'currentColor');
        const path = document.createElement('path');
        path.setAttribute('d', 'M13.23 1h-1.46L3.52 9.25l-.16.22L2 13.59l4.12-1.36.22-.16L14.59 3.23V1.77L13.23 1zM2.41 13.59l.72-2.17 1.45 1.45-2.17.72zm2.5-2.07L3.53 10.1 10.8 2.83l1.38 1.38-7.27 7.27z');
        icon.appendChild(path);
        this.displayElement.appendChild(icon);

        // Create edit element
        this.editElement = document.createElement('div');
        this.editElement.className = 'field-edit hidden';

        this.inputElement = document.createElement(this.isTextarea ? 'textarea' : 'input');
        if (!this.isTextarea) {
          this.inputElement.type = 'text';
        }
        this.inputElement.className = this.isTextarea ? '' : 'input';
        if (this.isTextarea) {
          this.inputElement.rows = 4;
        }
        this.inputElement.onblur = () => this.handleBlur();
        this.inputElement.onkeydown = (e) => this.handleKeydown(e);

        const actions = document.createElement('div');
        actions.className = 'edit-actions';

        const acceptBtn = document.createElement('button');
        acceptBtn.type = 'button';
        acceptBtn.className = 'icon-button accept';
        acceptBtn.title = 'Save';
        acceptBtn.onclick = () => this.save();

        const acceptSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        acceptSvg.setAttribute('viewBox', '0 0 16 16');
        acceptSvg.setAttribute('fill', 'currentColor');
        const acceptPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        acceptPath.setAttribute('d', 'M14.431 3.323l-8.47 10-.79-.036-3.35-4.77.818-.574 2.978 4.24 8.051-9.506.764.646z');
        acceptSvg.appendChild(acceptPath);
        acceptBtn.appendChild(acceptSvg);

        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'icon-button cancel';
        cancelBtn.title = 'Cancel';
        cancelBtn.onclick = () => this.cancel();

        const cancelSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        cancelSvg.setAttribute('viewBox', '0 0 16 16');
        cancelSvg.setAttribute('fill', 'currentColor');
        const cancelPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        cancelPath.setAttribute('d', 'M8 8.707l3.646 3.647.708-.707L8.707 8l3.647-3.646-.707-.708L8 7.293 4.354 3.646l-.707.708L7.293 8l-3.646 3.646.707.708L8 8.707z');
        cancelSvg.appendChild(cancelPath);
        cancelBtn.appendChild(cancelSvg);

        actions.appendChild(acceptBtn);
        actions.appendChild(cancelBtn);

        this.editElement.appendChild(this.inputElement);
        this.editElement.appendChild(actions);

        this.container.appendChild(this.displayElement);
        this.container.appendChild(this.editElement);
        console.log('EditableField init completed, container:', this.container);
      }

      getElement() {
        console.log('getElement called, container:', this.container);
        return this.container;
      }

      setValue(value) {
        this.currentValue = value || '';
        this.originalValue = this.currentValue;
        this.updateDisplay();
      }

      updateDisplay() {
        const textElement = this.displayElement.querySelector('.field-text');
        if (!this.currentValue) {
          textElement.textContent = this.placeholder;
          textElement.classList.add('placeholder');
        } else {
          textElement.textContent = this.currentValue;
          textElement.classList.remove('placeholder');
        }

        if (this.onDisplayUpdate) {
          this.onDisplayUpdate(this.currentValue);
        }
      }

      enterEditMode() {
        this.displayElement.classList.add('hidden');
        this.editElement.classList.remove('hidden');
        this.inputElement.value = this.currentValue;
        this.inputElement.focus();
        this.inputElement.select();
        this.isDirty = false;
      }

      exitEditMode() {
        this.displayElement.classList.remove('hidden');
        this.editElement.classList.add('hidden');
        this.isDirty = false;
      }

      handleBlur() {
        // If value hasn't changed, exit edit mode
        if (!this.isDirty) {
          this.exitEditMode();
        }
        // If value has changed (dirty), stay in edit mode - user must explicitly save/cancel
      }

      handleKeydown(e) {
        if (e.key === 'Enter' && !this.isTextarea) {
          e.preventDefault();
          this.save();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          this.cancel();
        } else if (e.key === 'Tab') {
          // Allow tab navigation, but mark as dirty if value changed
          this.checkDirty();
        } else {
          // Mark as dirty on any input change
          setTimeout(() => this.checkDirty(), 0);
        }
      }

      checkDirty() {
        const newValue = this.inputElement.value.trim();
        this.isDirty = newValue !== this.originalValue;
      }

      save() {
        const newValue = this.inputElement.value.trim();
        this.currentValue = newValue;
        this.updateDisplay();
        this.exitEditMode();

        if (this.onSave) {
          this.onSave(newValue);
        }
      }

      cancel() {
        this.currentValue = this.originalValue;
        this.updateDisplay();
        this.exitEditMode();

        if (this.onCancel) {
          this.onCancel();
        }
      }
    }

    // Create editable field instances
    let titleField, descriptionField, commentAuthorField;
    let currentCommentAuthor = 'user';

    // Utility functions for creating pill components
    function createTypeBadge(type) {
      const badge = document.createElement('span');
      badge.className = `type-badge ${type || 'task'}`;
      badge.textContent = type || 'Task';
      return badge;
    }

    function createStatusPill(status, displayText = null) {
      const pill = document.createElement('span');
      const displayStatus = status || 'open';
      const text = displayText || (displayStatus === 'in_progress' ? 'In Progress' :
        (displayStatus.charAt(0).toUpperCase() + displayStatus.slice(1)));
      pill.className = `subtask-status ${displayStatus}`;
      pill.textContent = text;
      return pill;
    }

    function createPriorityPill(priority) {
      const pill = document.createElement('span');
      const displayPriority = priority || 'medium';
      pill.className = `subtask-priority ${displayPriority}`;
      pill.textContent = displayPriority.charAt(0).toUpperCase() + displayPriority.slice(1);
      return pill;
    }

    function createDependencyStatusPill(status, displayText = null) {
      const pill = document.createElement('span');
      const displayStatus = status || 'open';
      const text = displayText || (displayStatus === 'in_progress' ? 'In Progress' :
        (displayStatus.charAt(0).toUpperCase() + displayStatus.slice(1)));
      pill.className = `dependency-status ${displayStatus}`;
      pill.textContent = text;
      return pill;
    }

    function createDependencyPriorityPill(priority) {
      const pill = document.createElement('span');
      const displayPriority = priority || 'medium';
      pill.className = `dependency-priority ${displayPriority}`;
      pill.textContent = displayPriority.charAt(0).toUpperCase() + displayPriority.slice(1);
      return pill;
    }

    function createRemoveIcon() {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('viewBox', '0 0 1024 1024');
      svg.setAttribute('fill', 'currentColor');

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', 'M195.2 195.2a64 64 0 0 1 90.496 0L512 421.504 738.304 195.2a64 64 0 0 1 90.496 90.496L602.496 512 828.8 738.304a64 64 0 0 1-90.496 90.496L512 602.496 285.696 828.8a64 64 0 0 1-90.496-90.496L421.504 512 195.2 285.696a64 64 0 0 1 0-90.496z');

      svg.appendChild(path);
      return svg;
    }

    function editTask(id) {
      console.log('Editing task', id);
      console.log('vscode object:', vscode);
      console.log('typeof vscode.postMessage:', typeof vscode?.postMessage);
      try {
        const message = { type: 'editTicket', id };
        console.log('Attempting to post message:', message);
        vscode.postMessage(message);
        console.log('Message posted successfully');
      } catch (error) {
        console.error('Error posting message:', error);
      }
    }

    function createCalendarIcon() {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('viewBox', '0 0 24 24');
      svg.setAttribute('fill', 'none');
      svg.setAttribute('width', '18');
      svg.setAttribute('height', '18');
      svg.style.marginRight = '4px';
      svg.style.flexShrink = '0';

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', 'M3 9H21M7 3V5M17 3V5M6 12H10V16H6V12ZM6.2 21H17.8C18.9201 21 19.4802 21 19.908 20.782C20.2843 20.5903 20.5903 20.2843 20.782 19.908C21 19.4802 21 18.9201 21 17.8V8.2C21 7.07989 21 6.51984 20.782 6.09202C20.5903 5.71569 20.2843 5.40973 19.908 5.21799C19.4802 5 18.9201 5 17.8 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V17.8C3 18.9201 3 19.4802 3.21799 19.908C3.40973 20.2843 3.71569 20.5903 4.09202 20.782C4.51984 21 5.07989 21 6.2 21Z');
      path.setAttribute('stroke', 'currentColor');
      path.setAttribute('stroke-width', '2');
      path.setAttribute('stroke-linecap', 'round');
      path.setAttribute('stroke-linejoin', 'round');

      svg.appendChild(path);
      return svg;
    }

    function setDateWithIcon(elementId, isoString) {
      const element = document.getElementById(elementId);
      if (!element) return;

      // Clear existing content
      element.innerHTML = '';

      // Add calendar icon
      const icon = createCalendarIcon();
      element.appendChild(icon);

      // Add date text
      const textNode = document.createTextNode(formatDate(isoString));
      element.appendChild(textNode);
    }

    // Notify extension that webview is ready
    vscode.postMessage({ type: 'webviewReady' });
    vscode.postMessage({ type: 'getGitUser' });
    console.log('Webview ready message sent');

    window.addEventListener('message', event => {
      const message = event.data;
      console.log('Webview received message:', message);
      if (message.type === 'loadTicket') {
        ticketId = message.ticket.id;
        currentTitle = message.ticket.title || '';
        currentDescription = message.ticket.description || '';
        comments = message.ticket.comments || [];
        console.log('Loaded ticket:', ticketId, 'title:', currentTitle, 'desc:', currentDescription);
        document.getElementById('type').value = message.ticket.type || 'task';
        document.getElementById('priority').value = message.ticket.priority || 'medium';
        document.getElementById('status').value = message.ticket.status || 'open';
        subtasks = message.ticket.subtasks || [];
        dependencies = message.ticket.dependencies || [];
        acceptanceCriteria = message.ticket.acceptance_criteria || [];

        // Update closed date display based on status
        onStatusChange();

        // Populate metadata
        document.getElementById('ticketId').textContent = message.ticket.id;
        setDateWithIcon('createdDate', message.ticket.created_at);
        setDateWithIcon('updatedDate', message.ticket.updated_at);

        const closedContainer = document.getElementById('closedDateContainer');
        const closedDateEl = document.getElementById('closedDate');
        if (message.ticket.closed_at) {
          closedContainer.style.display = 'block';
          setDateWithIcon('closedDate', message.ticket.closed_at);
        } else {
          closedContainer.style.display = 'none';
        }

        // Initialize editable fields
        if (!titleField) {
          titleField = new EditableField({
            fieldName: 'title',
            placeholder: 'Click to add title...',
            isTextarea: false,
            onSave: (value) => {
              currentTitle = value;
              saveTicket();
            },
            onCancel: () => {
              // Cancel handled automatically
            },
            onDisplayUpdate: (value) => {
              // Update display handled automatically
            }
          });
          document.getElementById('titleContainer').appendChild(titleField.getElement());
        }
        titleField.setValue(currentTitle);

        if (!descriptionField) {
          try {
            descriptionField = new EditableField({
              fieldName: 'description',
              placeholder: 'Click to add description...',
              isTextarea: true,
              onSave: (value) => {
                currentDescription = value;
                saveTicket();
              },
              onCancel: () => {
                // Cancel handled automatically
              },
              onDisplayUpdate: (value) => {
                // Update display handled automatically
              }
            });
            const descContainer = document.getElementById('descriptionContainer');
            console.log('Description container found:', !!descContainer);
            if (descContainer) {
              const element = descriptionField.getElement();
              console.log('Description element to append:', element);
              descContainer.appendChild(element);
              console.log('Description element appended');
            } else {
              console.error('Description container not found');
            }
          } catch (error) {
            console.error('Error creating description field:', error);
          }
        }
        try {
          descriptionField.setValue(currentDescription);
        } catch (error) {
          console.error('Error setting description value:', error);
        }

        // Initialize comment author field if not already created
        if (!commentAuthorField) {
          commentAuthorField = new EditableField({
            fieldName: 'commentAuthor',
            placeholder: 'your-name',
            isTextarea: false,
            onSave: (value) => {
              currentCommentAuthor = value || 'user';
            },
            onCancel: () => {
              // Cancel handled automatically
            },
            onDisplayUpdate: (value) => {
              currentCommentAuthor = value || 'user';
            }
          });
          document.getElementById('commentAuthorContainer').appendChild(commentAuthorField.getElement());
          commentAuthorField.setValue(currentCommentAuthor);
        }

        renderComments();
        renderSubtasks();
        renderDependencies();
        renderAcceptanceCriteria();

        // Initialize accordion sections after content is loaded
        setTimeout(initializeSections, 50);
      } else if (message.type === 'availableSubtasks') {
        availableSubtasks = message.subtasks;
        renderAvailableSubtasks();
        document.getElementById('subtaskModal').classList.remove('hidden');
        document.getElementById('subtaskSearch').focus();
      } else if (message.type === 'availableDependencies') {
        availableDependencies = message.dependencies;
        renderAvailableDependencies();
        document.getElementById('dependencyModal').classList.remove('hidden');
        document.getElementById('dependencySearch').focus();
      } else if (message.type === 'commentAdded') {
        comments.push(message.comment);
        renderComments();
      } else if (message.type === 'gitUserInfo') {
        console.log('Received git user info:', message);
        // Priority: git user.name > git user.email > "user"
        let authorName = 'user';
        if (message.userName) {
          authorName = message.userName;
        } else if (message.userEmail) {
          authorName = message.userEmail;
        }
        currentCommentAuthor = authorName;
        if (commentAuthorField) {
          commentAuthorField.setValue(authorName);
        }
      }
    });

    function saveTicket() {
      console.log('Saving ticket, ticketId:', ticketId, 'title:', currentTitle, 'desc:', currentDescription);
      const ticket = {
        id: ticketId,
        title: currentTitle,
        description: currentDescription,
        comments: comments,
        type: document.getElementById('type').value,
        priority: document.getElementById('priority').value,
        status: document.getElementById('status').value,
        subtasks: subtasks,
        dependencies: dependencies,
        acceptance_criteria: acceptanceCriteria
      };
      console.log('Sending saveTicket message:', ticket);
      vscode.postMessage({ type: 'saveTicket', ticket });
    }

    function renderSubtasks() {
      const list = document.getElementById('subtasksList');
      list.innerHTML = '';
      subtasks.forEach((subtask, index) => {
        const div = document.createElement('div');
        div.className = 'subtask';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'subtask-info';

        const typeBadge = createTypeBadge(subtask.type);

        const titleIdContainer = document.createElement('div');
        titleIdContainer.className = 'task-id-container';

        const idDiv = document.createElement('div');
        idDiv.className = 'task-id';
        const idText = document.createElement('span');
        idText.textContent = subtask.id;
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-id-btn';
        copyBtn.title = 'Copy ID to clipboard';
        copyBtn.innerHTML = '<svg fill="#000000" viewBox="0 0 36 36" version="1.1" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>copy-to-clipboard-line</title> <path d="M22.6,4H21.55a3.89,3.89,0,0,0-7.31,0H13.4A2.41,2.41,0,0,0,11,6.4V10H25V6.4A2.41,2.41,0,0,0,22.6,4ZM23,8H13V6.25A.25.25,0,0,1,13.25,6h2.69l.12-1.11A1.24,1.24,0,0,1,16.61,4a2,2,0,0,1,3.15,1.18l.09.84h2.9a.25.25,0,0,1,.25.25Z" class="clr-i-outline clr-i-outline-path-1"></path><path d="M33.25,18.06H21.33l2.84-2.83a1,1,0,1,0-1.42-1.42L17.5,19.06l5.25,5.25a1,1,0,0,0,.71.29,1,1,0,0,0,.71-1.7l-2.84-2.84H33.25a1,1,0,0,0,0-2Z" class="clr-i-outline clr-i-outline-path-2"></path><path d="M29,16h2V6.68A1.66,1.66,0,0,0,29.35,5H27.08V7H29Z" class="clr-i-outline clr-i-outline-path-3"></path><path d="M29,31H7V7H9V5H6.64A1.66,1.66,0,0,0,5,6.67V31.32A1.66,1.66,0,0,0,6.65,33H29.36A1.66,1.66,0,0,0,31,31.33V22.06H29Z" class="clr-i-outline clr-i-outline-path-4"></path> <rect x="0" y="0" width="36" height="36" fill-opacity="0"></rect> </g></svg>';
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(subtask.id);
        };
        idDiv.appendChild(idText);
        idDiv.appendChild(copyBtn);

        const titleSpan = document.createElement('span');
        titleSpan.className = 'subtask-title';
        titleSpan.textContent = subtask.title;
        titleSpan.style.cursor = 'pointer';
        titleSpan.onclick = () => editTask(subtask.id);

        titleIdContainer.appendChild(idDiv);
        titleIdContainer.appendChild(titleSpan);

        infoDiv.appendChild(typeBadge);
        infoDiv.appendChild(titleIdContainer);

        const statusPill = createStatusPill(subtask.status);
        const priorityPill = createPriorityPill(subtask.priority);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'icon-button remove';
        removeBtn.title = 'Remove subtask';
        removeBtn.appendChild(createRemoveIcon());
        removeBtn.onclick = () => removeSubtask(index);

        div.appendChild(infoDiv);
        div.appendChild(statusPill);
        div.appendChild(priorityPill);
        div.appendChild(removeBtn);

        list.appendChild(div);
      });

      // Update collapsible section height
      const section = list.closest('.collapsible-body');
      if (section && !section.classList.contains('collapsed')) {
        section.style.maxHeight = section.scrollHeight + 'px';
      }
    }

    function renderDependencies() {
      const blockedByList = document.getElementById('blockedByList');
      const blockingList = document.getElementById('blockingList');
      blockedByList.innerHTML = '';
      blockingList.innerHTML = '';

      dependencies.forEach((dep, index) => {
        const div = document.createElement('div');
        div.className = 'dependency';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'dependency-info';

        const typeBadge = createTypeBadge(dep.type);

        const titleIdContainer = document.createElement('div');
        titleIdContainer.className = 'task-id-container';

        const idDiv = document.createElement('div');
        idDiv.className = 'task-id';
        const idText = document.createElement('span');
        idText.textContent = dep.id;
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-id-btn';
        copyBtn.title = 'Copy ID to clipboard';
        copyBtn.innerHTML = '<svg fill="#000000" viewBox="0 0 36 36" version="1.1" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>copy-to-clipboard-line</title> <path d="M22.6,4H21.55a3.89,3.89,0,0,0-7.31,0H13.4A2.41,2.41,0,0,0,11,6.4V10H25V6.4A2.41,2.41,0,0,0,22.6,4ZM23,8H13V6.25A.25.25,0,0,1,13.25,6h2.69l.12-1.11A1.24,1.24,0,0,1,16.61,4a2,2,0,0,1,3.15,1.18l.09.84h2.9a.25.25,0,0,1,.25.25Z" class="clr-i-outline clr-i-outline-path-1"></path><path d="M33.25,18.06H21.33l2.84-2.83a1,1,0,1,0-1.42-1.42L17.5,19.06l5.25,5.25a1,1,0,0,0,.71.29,1,1,0,0,0,.71-1.7l-2.84-2.84H33.25a1,1,0,0,0,0-2Z" class="clr-i-outline clr-i-outline-path-2"></path><path d="M29,16h2V6.68A1.66,1.66,0,0,0,29.35,5H27.08V7H29Z" class="clr-i-outline clr-i-outline-path-3"></path><path d="M29,31H7V7H9V5H6.64A1.66,1.66,0,0,0,5,6.67V31.32A1.66,1.66,0,0,0,6.65,33H29.36A1.66,1.66,0,0,0,31,31.33V22.06H29Z" class="clr-i-outline clr-i-outline-path-4"></path> <rect x="0" y="0" width="36" height="36" fill-opacity="0"></rect> </g></svg>';
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(dep.id);
        };
        idDiv.appendChild(idText);
        idDiv.appendChild(copyBtn);

        const titleSpan = document.createElement('span');
        titleSpan.className = 'dependency-title';
        titleSpan.textContent = dep.title;
        titleSpan.style.cursor = 'pointer';
        titleSpan.onclick = () => editTask(dep.id);

        titleIdContainer.appendChild(idDiv);
        titleIdContainer.appendChild(titleSpan);

        infoDiv.appendChild(typeBadge);
        infoDiv.appendChild(titleIdContainer);

        const statusPill = createDependencyStatusPill(dep.status);
        const priorityPill = createDependencyPriorityPill(dep.priority);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'icon-button remove';
        removeBtn.title = 'Remove dependency';
        removeBtn.appendChild(createRemoveIcon());
        removeBtn.onclick = () => removeDependency(index);

        div.appendChild(infoDiv);
        div.appendChild(statusPill);
        div.appendChild(priorityPill);
        div.appendChild(removeBtn);

        if (dep.direction === 'blocks') {
          blockedByList.appendChild(div);
        } else {
          blockingList.appendChild(div);
        }
      });

      // Update collapsible section height
      const section = blockedByList.closest('.collapsible-body');
      if (section && !section.classList.contains('collapsed')) {
        section.style.maxHeight = section.scrollHeight + 'px';
      }
    }

    let acceptanceCriteriaFields = [];

    function renderAcceptanceCriteria() {
      const list = document.getElementById('acceptanceCriteriaList');
      list.innerHTML = '';

      // Clear existing field references
      acceptanceCriteriaFields = [];

      acceptanceCriteria.forEach((criteria, index) => {
        const div = document.createElement('div');
        div.className = 'acceptance-criteria-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'acceptance-criteria-checkbox';
        checkbox.checked = criteria.completed || false;
        checkbox.onchange = () => toggleAcceptanceCriteria(index);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'acceptance-criteria-content';

        // Create container for the editable text
        const textContainer = document.createElement('div');
        textContainer.className = 'acceptance-criteria-text-container';

        // Create EditableField for the criteria text
        const criteriaField = new EditableField({
          fieldName: `acceptance-criteria-${index}`,
          placeholder: 'Click to add acceptance criteria...',
          isTextarea: false,
          onSave: (value) => {
            acceptanceCriteria[index].text = value;
            saveTicket();
          },
          onCancel: () => {
            // Cancel handled automatically
          },
          onDisplayUpdate: (value) => {
            // Update display handled automatically
          }
        });

        // Set the current value
        criteriaField.setValue(criteria.text);

        // Append the editable field to the container
        textContainer.appendChild(criteriaField.getElement());

        // Store reference to the field
        acceptanceCriteriaFields[index] = criteriaField;

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'acceptance-criteria-actions';

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'icon-button remove';
        removeBtn.title = 'Remove acceptance criteria';
        removeBtn.appendChild(createRemoveIcon());
        removeBtn.onclick = () => removeAcceptanceCriteria(index);

        actionsDiv.appendChild(removeBtn);
        contentDiv.appendChild(textContainer);
        div.appendChild(checkbox);
        div.appendChild(contentDiv);
        div.appendChild(actionsDiv);

        list.appendChild(div);
      });

      // Update collapsible section height
      const section = list.closest('.collapsible-body');
      if (section && !section.classList.contains('collapsed')) {
        section.style.maxHeight = section.scrollHeight + 'px';
      }
    }

    function toggleAcceptanceCriteria(index) {
      acceptanceCriteria[index].completed = !acceptanceCriteria[index].completed;
      renderAcceptanceCriteria();
      saveTicket();
    }

    function removeAcceptanceCriteria(index) {
      acceptanceCriteria.splice(index, 1);
      renderAcceptanceCriteria();
      saveTicket();
    }

    function addAcceptanceCriteria() {
      acceptanceCriteria.push({
        text: 'New acceptance criteria',
        completed: false
      });
      renderAcceptanceCriteria();
      saveTicket();
    }

    function removeSubtask(index) {
      subtasks.splice(index, 1);
      renderSubtasks();
      saveTicket();
    }

    function removeDependency(index) {
      dependencies.splice(index, 1);
      renderDependencies();
      saveTicket();
    }

    document.getElementById('addSubtask').addEventListener('click', () => {
      vscode.postMessage({ type: 'getAvailableSubtasks' });
    });

    document.getElementById('addDependency').addEventListener('click', () => {
      vscode.postMessage({ type: 'getAvailableDependencies' });
    });

    document.getElementById('addAcceptanceCriteria').addEventListener('click', () => {
      addAcceptanceCriteria();
    });

    document.getElementById('ticketForm').addEventListener('submit', (e) => {
      e.preventDefault();
    });

    // Modal handlers
    document.getElementById('cancelSubtaskSelection').addEventListener('click', () => {
      document.getElementById('subtaskModal').classList.add('hidden');
      selectedSubtaskIds.clear();
      document.getElementById('subtaskSearch').value = '';
    });

    document.getElementById('confirmSubtaskSelection').addEventListener('click', () => {
      if (selectedSubtaskIds.size > 0) {
        const selectedSubtasks = availableSubtasks.filter(s => selectedSubtaskIds.has(s.id));
        selectedSubtasks.forEach(selectedSubtask => {
          subtasks.push({
            id: selectedSubtask.id,
            title: selectedSubtask.title,
            type: selectedSubtask.type,
            status: selectedSubtask.status,
            priority: selectedSubtask.priority
          });
        });
        renderSubtasks();
        saveTicket();
      }
      document.getElementById('subtaskModal').classList.add('hidden');
      selectedSubtaskIds.clear();
      document.getElementById('subtaskSearch').value = '';
    });

    document.getElementById('subtaskSearch').addEventListener('input', (e) => {
      renderAvailableSubtasks(e.target.value);
    });

    function renderAvailableSubtasks(searchTerm = '') {
      const list = document.getElementById('availableSubtasks');
      list.innerHTML = '';

      const filtered = availableSubtasks
        .map(subtask => {
          const searchText = `${subtask.id} ${subtask.title} ${subtask.description}`.toLowerCase();
          const term = searchTerm.toLowerCase();
          let score = 0;

          if (searchText.includes(term)) {
            // Exact ID match gets highest score
            if (subtask.id.toLowerCase().includes(term)) score += 100;
            // Title match
            if (subtask.title.toLowerCase().includes(term)) score += 50;
            // Description match
            if (subtask.description.toLowerCase().includes(term)) score += 25;
            // Word boundaries get bonus
            if (new RegExp(`\\b${term}\\b`, 'i').test(searchText)) score += 10;
          }

          return { ...subtask, score };
        })
        .filter(subtask => subtask.score > 0 || !searchTerm)
        .sort((a, b) => b.score - a.score);

      filtered.forEach(subtask => {
        const div = document.createElement('div');
        div.className = `subtask-item ${selectedSubtaskIds.has(subtask.id) ? 'selected' : ''}`;

        // Checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'subtask-checkbox';
        checkbox.checked = selectedSubtaskIds.has(subtask.id);
        checkbox.onclick = (e) => {
          e.stopPropagation();
          e.preventDefault();
          toggleSubtaskSelection(subtask.id);
          // Update checkbox state manually since we prevented default
          checkbox.checked = selectedSubtaskIds.has(subtask.id);
        };

        // Content container
        const contentDiv = document.createElement('div');
        contentDiv.className = 'subtask-content';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'subtask-info';

        const typeBadge = createTypeBadge(subtask.type);

        const titleIdContainer = document.createElement('div');
        titleIdContainer.className = 'task-id-container';

        const idDiv = document.createElement('div');
        idDiv.className = 'task-id';
        const idText = document.createElement('span');
        idText.textContent = subtask.id;
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-id-btn';
        copyBtn.title = 'Copy ID to clipboard';
        copyBtn.innerHTML = '<svg fill="#000000" viewBox="0 0 36 36" version="1.1" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>copy-to-clipboard-line</title> <path d="M22.6,4H21.55a3.89,3.89,0,0,0-7.31,0H13.4A2.41,2.41,0,0,0,11,6.4V10H25V6.4A2.41,2.41,0,0,0,22.6,4ZM23,8H13V6.25A.25.25,0,0,1,13.25,6h2.69l.12-1.11A1.24,1.24,0,0,1,16.61,4a2,2,0,0,1,3.15,1.18l.09.84h2.9a.25.25,0,0,1,.25.25Z" class="clr-i-outline clr-i-outline-path-1"></path><path d="M33.25,18.06H21.33l2.84-2.83a1,1,0,1,0-1.42-1.42L17.5,19.06l5.25,5.25a1,1,0,0,0,.71.29,1,1,0,0,0,.71-1.7l-2.84-2.84H33.25a1,1,0,0,0,0-2Z" class="clr-i-outline clr-i-outline-path-2"></path><path d="M29,16h2V6.68A1.66,1.66,0,0,0,29.35,5H27.08V7H29Z" class="clr-i-outline clr-i-outline-path-3"></path><path d="M29,31H7V7H9V5H6.64A1.66,1.66,0,0,0,5,6.67V31.32A1.66,1.66,0,0,0,6.65,33H29.36A1.66,1.66,0,0,0,31,31.33V22.06H29Z" class="clr-i-outline clr-i-outline-path-4"></path> <rect x="0" y="0" width="36" height="36" fill-opacity="0"></rect> </g></svg>';
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(subtask.id);
        };
        idDiv.appendChild(idText);
        idDiv.appendChild(copyBtn);

        const titleSpan = document.createElement('span');
        titleSpan.className = 'subtask-title';
        titleSpan.textContent = subtask.title;

        titleIdContainer.appendChild(idDiv);
        titleIdContainer.appendChild(titleSpan);

        infoDiv.appendChild(typeBadge);
        infoDiv.appendChild(titleIdContainer);

        const statusPill = createStatusPill(subtask.status);
        const priorityPill = createPriorityPill(subtask.priority);

        contentDiv.appendChild(infoDiv);
        contentDiv.appendChild(statusPill);
        contentDiv.appendChild(priorityPill);

        // Row click handler (selects only this item)
        div.onclick = () => selectSingleSubtask(subtask.id);

        div.appendChild(checkbox);
        div.appendChild(contentDiv);

        list.appendChild(div);
      });

      // Update modal title to show selection count
      updateModalTitle();
    }

    function selectSingleSubtask(id) {
      selectedSubtaskIds.clear();
      selectedSubtaskIds.add(id);
      renderAvailableSubtasks(document.getElementById('subtaskSearch').value);
    }

    function toggleSubtaskSelection(id) {
      if (selectedSubtaskIds.has(id)) {
        selectedSubtaskIds.delete(id);
      } else {
        selectedSubtaskIds.add(id);
      }
      renderAvailableSubtasks(document.getElementById('subtaskSearch').value);
    }

    function updateModalTitle() {
      const titleEl = document.querySelector('.modal-title');
      const count = selectedSubtaskIds.size;
      if (count === 0) {
        titleEl.textContent = 'Select Subtasks';
      } else if (count === 1) {
        titleEl.textContent = 'Select Subtasks (1 selected)';
      } else {
        titleEl.textContent = `Select Subtasks (${count} selected)`;
      }
    }

    // Dependency modal handlers
    document.getElementById('cancelDependencySelection').addEventListener('click', () => {
      document.getElementById('dependencyModal').classList.add('hidden');
      selectedDependencyIds.clear();
      document.getElementById('dependencySearch').value = '';
    });

    document.getElementById('confirmDependencySelection').addEventListener('click', () => {
      const direction = document.querySelector('input[name="dependencyDirection"]:checked').value;
      if (selectedDependencyIds.size > 0) {
        const selectedDeps = availableDependencies.filter(d => selectedDependencyIds.has(d.id));
        selectedDeps.forEach(selectedDep => {
          dependencies.push({
            id: selectedDep.id,
            title: selectedDep.title,
            type: selectedDep.type,
            status: selectedDep.status,
            priority: selectedDep.priority,
            direction: direction
          });
        });
        renderDependencies();
        saveTicket();
      }
      document.getElementById('dependencyModal').classList.add('hidden');
      selectedDependencyIds.clear();
      document.getElementById('dependencySearch').value = '';
    });

    document.getElementById('dependencySearch').addEventListener('input', (e) => {
      renderAvailableDependencies(e.target.value);
    });

    function renderAvailableDependencies(searchTerm = '') {
      const list = document.getElementById('availableDependencies');
      list.innerHTML = '';

      const filtered = availableDependencies
        .map(dep => {
          const searchText = `${dep.id} ${dep.title} ${dep.description}`.toLowerCase();
          const term = searchTerm.toLowerCase();
          let score = 0;

          if (searchText.includes(term)) {
            // Exact ID match gets highest score
            if (dep.id.toLowerCase().includes(term)) score += 100;
            // Title match
            if (dep.title.toLowerCase().includes(term)) score += 50;
            // Description match
            if (dep.description.toLowerCase().includes(term)) score += 25;
            // Word boundaries get bonus
            if (new RegExp(`\\b${term}\\b`, 'i').test(searchText)) score += 10;
          }

          return { ...dep, score };
        })
        .filter(dep => dep.score > 0 || !searchTerm)
        .sort((a, b) => b.score - a.score);

      filtered.forEach(dep => {
        const div = document.createElement('div');
        div.className = `dependency-item ${selectedDependencyIds.has(dep.id) ? 'selected' : ''}`;

        // Checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'dependency-checkbox';
        checkbox.checked = selectedDependencyIds.has(dep.id);
        checkbox.onclick = (e) => {
          e.stopPropagation();
          e.preventDefault();
          toggleDependencySelection(dep.id);
          // Update checkbox state manually since we prevented default
          checkbox.checked = selectedDependencyIds.has(dep.id);
        };

        // Content container
        const contentDiv = document.createElement('div');
        contentDiv.className = 'dependency-content';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'dependency-info';

        const typeBadge = createTypeBadge(dep.type);

        const titleIdContainer = document.createElement('div');
        titleIdContainer.className = 'task-id-container';

        const idDiv = document.createElement('div');
        idDiv.className = 'task-id';
        const idText = document.createElement('span');
        idText.textContent = dep.id;
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-id-btn';
        copyBtn.title = 'Copy ID to clipboard';
        copyBtn.innerHTML = '<svg fill="#000000" viewBox="0 0 36 36" version="1.1" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>copy-to-clipboard-line</title> <path d="M22.6,4H21.55a3.89,3.89,0,0,0-7.31,0H13.4A2.41,2.41,0,0,0,11,6.4V10H25V6.4A2.41,2.41,0,0,0,22.6,4ZM23,8H13V6.25A.25.25,0,0,1,13.25,6h2.69l.12-1.11A1.24,1.24,0,0,1,16.61,4a2,2,0,0,1,3.15,1.18l.09.84h2.9a.25.25,0,0,1,.25.25Z" class="clr-i-outline clr-i-outline-path-1"></path><path d="M33.25,18.06H21.33l2.84-2.83a1,1,0,1,0-1.42-1.42L17.5,19.06l5.25,5.25a1,1,0,0,0,.71.29,1,1,0,0,0,.71-1.7l-2.84-2.84H33.25a1,1,0,0,0,0-2Z" class="clr-i-outline clr-i-outline-path-2"></path><path d="M29,16h2V6.68A1.66,1.66,0,0,0,29.35,5H27.08V7H29Z" class="clr-i-outline clr-i-outline-path-3"></path><path d="M29,31H7V7H9V5H6.64A1.66,1.66,0,0,0,5,6.67V31.32A1.66,1.66,0,0,0,6.65,33H29.36A1.66,1.66,0,0,0,31,31.33V22.06H29Z" class="clr-i-outline clr-i-outline-path-4"></path> <rect x="0" y="0" width="36" height="36" fill-opacity="0"></rect> </g></svg>';
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(dep.id);
        };
        idDiv.appendChild(idText);
        idDiv.appendChild(copyBtn);

        const titleSpan = document.createElement('span');
        titleSpan.className = 'dependency-title';
        titleSpan.textContent = dep.title;

        titleIdContainer.appendChild(idDiv);
        titleIdContainer.appendChild(titleSpan);

        infoDiv.appendChild(typeBadge);
        infoDiv.appendChild(titleIdContainer);

        const statusPill = createDependencyStatusPill(dep.status);
        const priorityPill = createDependencyPriorityPill(dep.priority);

        contentDiv.appendChild(infoDiv);
        contentDiv.appendChild(statusPill);
        contentDiv.appendChild(priorityPill);

        // Row click handler (selects only this item)
        div.onclick = () => selectSingleDependency(dep.id);

        div.appendChild(checkbox);
        div.appendChild(contentDiv);

        list.appendChild(div);
      });

      // Update modal title to show selection count
      updateDependencyModalTitle();
    }

    function selectSingleDependency(id) {
      selectedDependencyIds.clear();
      selectedDependencyIds.add(id);
      renderAvailableDependencies(document.getElementById('dependencySearch').value);
    }

    function toggleDependencySelection(id) {
      if (selectedDependencyIds.has(id)) {
        selectedDependencyIds.delete(id);
      } else {
        selectedDependencyIds.add(id);
      }
      renderAvailableDependencies(document.getElementById('dependencySearch').value);
    }

    function updateDependencyModalTitle() {
      const titleEl = document.querySelector('#dependencyModal .modal-title');
      const count = selectedDependencyIds.size;
      if (count === 0) {
        titleEl.textContent = 'Select Dependencies';
      } else if (count === 1) {
        titleEl.textContent = 'Select Dependencies (1 selected)';
      } else {
        titleEl.textContent = `Select Dependencies (${count} selected)`;
      }
    }

    function createUserIcon() {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('class', 'comment-icon');
      svg.setAttribute('viewBox', '0 0 24 24');
      svg.setAttribute('fill', 'none');

      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', '12');
      circle.setAttribute('cy', '12');
      circle.setAttribute('r', '11');
      circle.setAttribute('fill', 'currentColor');
      circle.setAttribute('opacity', '0.2');

      const path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path1.setAttribute('d', 'M17.488 20.112C15.8837 21.1504 13.9825 21.75 12 21.75C10.0175 21.75 8.11623 21.1503 6.5117 20.1111C5.81815 19.6463 5.53009 18.7562 5.94819 18.0132C6.79101 16.5302 8.55973 15.5 12 15.5C15.4403 15.5 17.209 16.5303 18.0518 18.0132C18.4699 18.7562 18.1818 19.6464 17.488 20.112Z');
      path1.setAttribute('fill', 'currentColor');

      const path2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path2.setAttribute('d', 'M12 13C14.0711 13 15.75 11.3211 15.75 9.25C15.75 7.17893 14.0711 5.5 12 5.5C9.92893 5.5 8.25 7.17893 8.25 9.25C8.25 11.3211 9.92893 13 12 13Z');
      path2.setAttribute('fill', 'currentColor');

      svg.appendChild(circle);
      svg.appendChild(path1);
      svg.appendChild(path2);
      return svg;
    }

    function createAgentIcon() {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('class', 'comment-icon agent-icon');
      svg.setAttribute('viewBox', '0 0 512 416');
      svg.setAttribute('fill', 'currentColor');
      svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');

      const path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path1.setAttribute('d', 'M181.33 266.143c0-11.497 9.32-20.818 20.818-20.818 11.498 0 20.819 9.321 20.819 20.818v38.373c0 11.497-9.321 20.818-20.819 20.818-11.497 0-20.818-9.32-20.818-20.818v-38.373zM308.807 245.325c-11.477 0-20.798 9.321-20.798 20.818v38.373c0 11.497 9.32 20.818 20.798 20.818 11.497 0 20.818-9.32 20.818-20.818v-38.373c0-11.497-9.32-20.818-20.818-20.818z');
      path1.setAttribute('fill-rule', 'nonzero');

      const path2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path2.setAttribute('d', 'M512.002 246.393v57.384c-.02 7.411-3.696 14.638-9.67 19.011C431.767 374.444 344.695 416 256 416c-98.138 0-196.379-56.542-246.33-93.21-5.975-4.374-9.65-11.6-9.671-19.012v-57.384a35.347 35.347 0 016.857-20.922l15.583-21.085c8.336-11.312 20.757-14.31 33.98-14.31 4.988-56.953 16.794-97.604 45.024-127.354C155.194 5.77 226.56 0 256 0c29.441 0 100.807 5.77 154.557 62.722 28.19 29.75 40.036 70.401 45.025 127.354 13.263 0 25.602 2.936 33.958 14.31l15.583 21.127c4.476 6.077 6.878 13.345 6.878 20.88zm-97.666-26.075c-.677-13.058-11.292-18.19-22.338-21.824-11.64 7.309-25.848 10.183-39.46 10.183-14.454 0-41.432-3.47-63.872-25.869-5.667-5.625-9.527-14.454-12.155-24.247a212.902 212.902 0 00-20.469-1.088c-6.098 0-13.099.349-20.551 1.088-2.628 9.793-6.509 18.622-12.155 24.247-22.4 22.4-49.418 25.87-63.872 25.87-13.612 0-27.86-2.855-39.501-10.184-11.005 3.613-21.558 8.828-22.277 21.824-1.17 24.555-1.272 49.11-1.375 73.645-.041 12.318-.082 24.658-.288 36.976.062 7.166 4.374 13.818 10.882 16.774 52.97 24.124 103.045 36.278 149.137 36.278 46.01 0 96.085-12.154 149.014-36.278 6.508-2.956 10.84-9.608 10.881-16.774.637-36.832.124-73.809-1.642-110.62h.041zM107.521 168.97c8.643 8.623 24.966 14.392 42.56 14.392 13.448 0 39.03-2.874 60.156-24.329 9.28-8.951 15.05-31.35 14.413-54.079-.657-18.231-5.769-33.28-13.448-39.665-8.315-7.371-27.203-10.574-48.33-8.644-22.399 2.238-41.267 9.588-50.875 19.833-20.798 22.728-16.323 80.317-4.476 92.492zm130.556-56.008c.637 3.51.965 7.35 1.273 11.517 0 2.875 0 5.77-.308 8.952 6.406-.636 11.847-.636 16.959-.636s10.553 0 16.959.636c-.329-3.182-.329-6.077-.329-8.952.329-4.167.657-8.007 1.294-11.517-6.735-.637-12.812-.965-17.924-.965s-11.21.328-17.924.965zm49.275-8.008c-.637 22.728 5.133 45.128 14.413 54.08 21.105 21.454 46.708 24.328 60.155 24.328 17.596 0 33.918-5.769 42.561-14.392 11.847-12.175 16.322-69.764-4.476-92.492-9.608-10.245-28.476-17.595-50.875-19.833-21.127-1.93-40.015 1.273-48.33 8.644-7.679 6.385-12.791 21.434-13.448 39.665z');

      svg.appendChild(path1);
      svg.appendChild(path2);
      return svg;
    }

    // Comment thread functions
    function renderComments() {
      const thread = document.getElementById('commentsThread');
      thread.innerHTML = '';

      if (!comments || comments.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'comments-empty';
        empty.textContent = 'No comments yet. Add a comment below to start the conversation.';
        thread.appendChild(empty);
        return;
      }

      comments.forEach(comment => {
        const item = document.createElement('div');
        item.className = 'comment-item';

        const header = document.createElement('div');
        header.className = 'comment-header';

        const isAgent = comment.author === 'agent' || comment.author === 'developer';

        // Add icon
        const icon = isAgent ? createAgentIcon() : createUserIcon();
        header.appendChild(icon);

        const author = document.createElement('span');
        author.className = `comment-author ${isAgent ? 'agent' : ''}`;
        author.textContent = isAgent ? 'Agent' : comment.author;

        const timestamp = document.createElement('span');
        timestamp.className = 'comment-timestamp';
        timestamp.textContent = formatTimestamp(comment.created_at);

        header.appendChild(author);
        header.appendChild(document.createTextNode('‚Ä¢'));
        header.appendChild(timestamp);

        const content = document.createElement('div');
        content.className = 'comment-content';
        content.textContent = comment.content;

        item.appendChild(header);
        item.appendChild(content);
        thread.appendChild(item);
      });

      // Update collapsible section height
      const section = thread.closest('.collapsible-body');
      if (section && !section.classList.contains('collapsed')) {
        section.style.maxHeight = section.scrollHeight + 'px';
      }
    }

    function formatDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatTimestamp(isoString) {
      const date = new Date(isoString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins} min${diffMins === 1 ? '' : 's'} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
      return date.toLocaleDateString();
    }

    function onStatusChange() {
      const status = document.getElementById('status').value;
      const closedContainer = document.getElementById('closedDateContainer');
      const closedDateEl = document.getElementById('closedDate');

      if (status === 'closed') {
        closedContainer.style.display = 'block';
        setDateWithIcon('closedDate', new Date().toISOString());
      } else {
        closedContainer.style.display = 'none';
      }
    }

    document.getElementById('addCommentBtn').addEventListener('click', () => {
      const input = document.getElementById('commentInput');
      const content = input.value.trim();
      const author = currentCommentAuthor || 'user';

      if (!content) return;

      // Send message to extension to add comment
      vscode.postMessage({
        type: 'addComment',
        issueId: ticketId,
        author: author,
        content: content
      });

      // Clear input
      input.value = '';
    });

    // Delete functionality
    let deleteConfirmPopup = null;

    document.getElementById('deleteTicket').addEventListener('click', function (e) {
      const button = e.target;

      // Close any existing popup
      if (deleteConfirmPopup) {
        deleteConfirmPopup.remove();
        deleteConfirmPopup = null;
        return;
      }

      // Create popup
      const popup = document.createElement('div');
      popup.className = 'delete-confirm-popup visible';

      const childCount = subtasks.length;

      const textEl = document.createElement('div');
      textEl.className = 'delete-confirm-text';
      if (childCount > 0) {
        textEl.innerHTML = `Delete <strong>${currentTitle}</strong>?<br><br>This will unparent ${childCount} subtask${childCount === 1 ? '' : 's'}.`;
      } else {
        textEl.innerHTML = `Delete <strong>${currentTitle}</strong>?`;
      }

      const buttonsEl = document.createElement('div');
      buttonsEl.className = 'delete-confirm-buttons';

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'delete-confirm-btn cancel';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.onclick = () => {
        popup.remove();
        deleteConfirmPopup = null;
      };

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-confirm-btn delete';
      deleteBtn.textContent = 'Delete';
      deleteBtn.onclick = () => {
        popup.remove();
        deleteConfirmPopup = null;
        vscode.postMessage({ type: 'deleteTask', id: ticketId });
      };

      buttonsEl.appendChild(cancelBtn);
      buttonsEl.appendChild(deleteBtn);

      popup.appendChild(textEl);
      popup.appendChild(buttonsEl);

      // Position popup relative to button
      document.body.appendChild(popup);
      const buttonRect = button.getBoundingClientRect();
      popup.style.position = 'fixed';
      popup.style.top = `${buttonRect.top - popup.offsetHeight - 4}px`;
      popup.style.left = `${buttonRect.left}px`;

      deleteConfirmPopup = popup;

      // Close popup when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closePopup(e) {
          if (popup && !popup.contains(e.target) && e.target !== button) {
            popup.remove();
            deleteConfirmPopup = null;
            document.removeEventListener('click', closePopup);
          }
        });
      }, 0);
    });

    function formatDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
  </script>
</body>

</html>