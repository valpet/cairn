<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horizon Task List</title>
  <style>
    body {
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      background-color: var(--vscode-editor-background);
      color: var(--vscode-editor-foreground);
      margin: 0;
      padding: 20px;
    }

    h1 {
      color: var(--vscode-textLink-foreground);
    }

    .controls {
      margin-bottom: 20px;
    }

    .filters {
      margin-bottom: 20px;
    }

    .filters label {
      margin-right: 15px;
    }

    .task-list {
      list-style: none;
      padding: 0;
    }

    .task-item {
      background-color: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border);
      border-radius: 4px;
      margin-bottom: 10px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-grid {
      width: 100%;
      border-collapse: collapse;
    }

    .task-grid th,
    .task-grid td {
      border: 1px solid var(--vscode-input-border);
      padding: 8px;
      text-align: left;
    }

    .task-grid th {
      background-color: var(--vscode-titleBar-activeBackground);
      color: var(--vscode-titleBar-activeForeground);
    }

    .task-actions {
      display: flex;
      gap: 5px;
    }

    button {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: 1px solid var(--vscode-button-border);
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
    }

    .task-description {
      font-size: 0.9em;
      opacity: 0.8;
      margin-top: 5px;
    }

    .task-title {
      font-weight: bold;
    }

    .pill {
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 0.8em;
      display: inline-block;
      text-transform: capitalize;
    }

    .status-open {
      background-color: var(--vscode-charts-green);
      color: white;
    }

    .status-in_progress {
      background-color: var(--vscode-charts-blue);
      color: white;
    }

    .status-closed {
      background-color: var(--vscode-charts-gray);
      color: white;
    }

    .status-blocked {
      background-color: var(--vscode-charts-red);
      color: white;
    }

    .priority-low {
      background-color: var(--vscode-charts-green);
      color: white;
    }

    .priority-medium {
      background-color: var(--vscode-charts-yellow);
      color: black;
    }

    .priority-high {
      background-color: var(--vscode-charts-orange);
      color: white;
    }

    .priority-urgent {
      background-color: var(--vscode-charts-red);
      color: white;
    }

    .type-task {
      background-color: var(--vscode-charts-blue);
      color: white;
    }
  </style>
</head>

<body>
  <h1>Horizon Task List</h1>
  <div class="controls">
    <label>View: <select id="view-selector">
        <option value="list">List</option>
        <option value="grid">Grid</option>
      </select></label>
  </div>
  <div class="filters">
    <label><input type="checkbox" id="filter-ready" checked> Ready Tasks</label>
    <label><input type="checkbox" id="filter-open"> Open</label>
    <label><input type="checkbox" id="filter-in_progress"> In Progress</label>
    <label><input type="checkbox" id="filter-closed"> Closed</label>
    <label><input type="checkbox" id="filter-blocked"> Blocked</label>
  </div>
  <div id="task-container">
    <!-- Tasks will be populated here -->
  </div>

  <script>
    // Function to check if a task is ready (no blocking dependencies)
    function isReady(task, allTasks) {
      if (!task.dependencies) return true;
      const taskMap = new Map(allTasks.map(t => [t.id, t]));
      return task.dependencies.every(dep => {
        if (dep.type !== 'blocks') return true;
        const depTask = taskMap.get(dep.id);
        return depTask && depTask.status === 'closed';
      });
    }

    // Function to render tasks
    function renderTasks(allTasks) {
      const view = document.getElementById('view-selector').value;
      const selectedStatuses = Array.from(document.querySelectorAll('.filters input:checked')).map(cb => cb.id.replace('filter-', ''));
      const filteredTasks = allTasks.filter(task => selectedStatuses.includes(task.status) || (selectedStatuses.includes('ready') && task.status === 'open' && isReady(task, allTasks)));
      const expandedTasks = getExpandedTasks(allTasks, filteredTasks);
      const taskTree = buildTaskTree(expandedTasks);

      const container = document.getElementById('task-container');
      container.innerHTML = '';

      if (view === 'list') {
        const ul = document.createElement('ul');
        ul.className = 'task-list';
        renderTaskTreeList(taskTree, ul);
        container.appendChild(ul);
      } else if (view === 'grid') {
        const table = document.createElement('table');
        table.className = 'task-grid';
        table.innerHTML = `
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Parent</th>
                            <th>Type</th>
                            <th>Title</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;
        const tbody = table.querySelector('tbody');
        renderTaskTree(taskTree, tbody);
        container.appendChild(table);
      }
    }

    // Function to get expanded tasks including ancestors
    function getExpandedTasks(allTasks, filteredTasks) {
      const taskMap = new Map(allTasks.map(t => [t.id, t]));
      const expanded = new Set(filteredTasks.map(t => t.id));
      const toProcess = [...filteredTasks];

      while (toProcess.length > 0) {
        const task = toProcess.pop();
        (task.dependencies || []).forEach(dep => {
          if (dep.type === 'parent-child') {
            if (!expanded.has(dep.id)) {
              expanded.add(dep.id);
              const parent = taskMap.get(dep.id);
              if (parent) toProcess.push(parent);
            }
          }
        });
      }

      return allTasks.filter(t => expanded.has(t.id));
    }

    // Function to build task hierarchy
    function buildTaskTree(tasks) {
      const taskMap = new Map();
      const roots = [];

      tasks.forEach(task => {
        taskMap.set(task.id, { ...task, children: [] });
      });

      tasks.forEach(task => {
        const node = taskMap.get(task.id);
        const parentDep = (task.dependencies || []).find(dep => dep.type === 'parent-child');
        if (parentDep) {
          const parent = taskMap.get(parentDep.id);
          if (parent) {
            parent.children.push(node);
          } else {
            roots.push(node);
          }
        } else {
          roots.push(node);
        }
      });

      return roots;
    }

    // Function to render task row
    function renderTaskRow(task, level = 0) {
      const indent = 10 + level * 40;
      const parentDep = (task.dependencies || []).find(dep => dep.type === 'parent-child');
      const parentId = parentDep ? parentDep.id : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
                    <td style="padding-left: ${indent}px;">${task.id}</td>
                    <td style="padding-left: ${indent}px;">${parentId}</td>
                    <td style="padding-left: ${indent}px;"><span class="pill type-${task.type || 'task'}">${task.type || 'task'}</span></td>
                    <td style="padding-left: ${indent}px;">${task.title}</td>
                    <td style="padding-left: ${indent}px;"><span class="pill status-${task.status}">${task.status}</span></td>
                    <td style="padding-left: ${indent}px;"><span class="pill priority-${task.priority}">${task.priority}</span></td>
                    <td class="task-actions">
                        ${task.status === 'open' ? '<button onclick="startTask(\'' + task.id + '\')">Start</button>' : ''}
                        ${task.status === 'in_progress' ? '<button onclick="completeTask(\'' + task.id + '\')">Complete</button>' : ''}
                    </td>
                `;
      return tr;
    }

    // Function to render task item for list
    function renderTaskItem(task, level = 0) {
      const parentDep = (task.dependencies || []).find(dep => dep.type === 'parent-child');
      const parentId = parentDep ? parentDep.id : '';
      const li = document.createElement('li');
      li.className = 'task-item';
      li.style.paddingLeft = level * 40 + 'px';
      li.innerHTML = `
                    <div>
                        <span class="task-title">${task.title}</span>
                        ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                        <span class="pill type-${task.type || 'task'}">${task.type || 'task'}</span>
                        <span class="pill status-${task.status}">${task.status}</span>
                        <span class="pill priority-${task.priority}">${task.priority}</span>
                        ${parentId ? `<span class="pill">Parent: ${parentId}</span>` : ''}
                    </div>
                    <div class="task-actions">
                        ${task.status === 'open' ? '<button onclick="startTask(\'' + task.id + '\')">Start</button>' : ''}
                        ${task.status === 'in_progress' ? '<button onclick="completeTask(\'' + task.id + '\')">Complete</button>' : ''}
                    </div>
                `;
      return li;
    }

    // Function to render task tree for list
    function renderTaskTreeList(tree, ul, level = 0) {
      tree.forEach(node => {
        const li = renderTaskItem(node, level);
        ul.appendChild(li);
        if (node.children.length > 0) {
          renderTaskTreeList(node.children, ul, level + 1);
        }
      });
    }

    // Function to render task tree
    function renderTaskTree(tree, tbody, level = 0) {
      tree.forEach(node => {
        const tr = renderTaskRow(node, level);
        tbody.appendChild(tr);
        if (node.children.length > 0) {
          renderTaskTree(node.children, tbody, level + 1);
        }
      });
    }

    // Task interaction functions
    function startTask(id) {
      vscode.postMessage({ type: 'startTask', id });
    }

    function completeTask(id) {
      vscode.postMessage({ type: 'completeTask', id });
    }

    // Initial render (will be updated via message)
    let allTasks = [];
    renderTasks([]);

    // Listen for messages from extension
    window.addEventListener('message', event => {
      const message = event.data;
      if (message.type === 'updateTasks') {
        allTasks = message.tasks;
        renderTasks(allTasks);
      }
    });

    // Add event listeners for filters
    document.querySelectorAll('.filters input').forEach(cb => {
      cb.addEventListener('change', () => renderTasks(allTasks));
    });

    // Add event listener for view selector
    document.getElementById('view-selector').addEventListener('change', () => renderTasks(allTasks));
  </script>
</body>

</html>