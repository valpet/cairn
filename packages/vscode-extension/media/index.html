<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horizon Task List</title>
  <style>
    body {
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      background-color: var(--vscode-sideBar-background);
      color: var(--vscode-foreground);
      margin: 0;
      padding: 20px;
    }

    h1 {
      color: #D4A556;
      font-size: 24px;
      margin: 0 0 20px 0;
    }

    .header {
      margin-bottom: 20px;
    }

    .controls {
      margin-bottom: 15px;
    }

    .controls label {
      font-weight: normal;
      margin-right: 10px;
    }

    .controls select {
      background-color: var(--vscode-dropdown-background);
      color: var(--vscode-dropdown-foreground);
      border: 1px solid var(--vscode-dropdown-border);
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
    }

    .filters {
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
    }

    .filters label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
    }

    .filters input[type="checkbox"] {
      cursor: pointer;
    }

    .task-grid {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--vscode-editor-background);
    }

    .task-grid th {
      background-color: var(--vscode-editor-background);
      color: var(--vscode-foreground);
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      border-bottom: 1px solid var(--vscode-panel-border);
      position: sticky;
      top: 0;
    }

    .task-grid th:first-child {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-controls {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }

    .header-btn {
      background: none;
      border: none;
      color: var(--vscode-foreground);
      cursor: pointer;
      padding: 4px 8px;
      opacity: 0.7;
      font-size: 12px;
    }

    .header-btn:hover {
      opacity: 1;
    }

    .task-grid td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--vscode-panel-border);
      vertical-align: middle;
    }

    .task-row {
      transition: background-color 0.1s;
    }

    .task-row:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .title-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .expand-icon {
      cursor: pointer;
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--vscode-foreground);
      opacity: 0.7;
      flex-shrink: 0;
    }

    .expand-icon:hover {
      opacity: 1;
    }

    .expand-icon.collapsed::before {
      content: '▶';
      font-size: 10px;
    }

    .expand-icon.expanded::before {
      content: '▼';
      font-size: 10px;
    }

    .expand-icon.empty {
      opacity: 0;
      cursor: default;
    }

    .type-badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .type-badge.epic {
      background-color: rgba(138, 98, 255, 0.2);
      color: #8A62FF;
    }

    .type-badge.epic::before {
      content: '⚡';
    }

    .type-badge.task {
      background-color: rgba(68, 131, 255, 0.2);
      color: #4483FF;
    }

    .type-badge.task::before {
      content: '•';
      font-size: 16px;
    }

    .task-title-text {
      color: var(--vscode-foreground);
    }

    .pill {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      display: inline-block;
      text-transform: capitalize;
    }

    .status-open {
      background-color: #2ea043;
      color: white;
    }

    .status-in_progress {
      background-color: var(--vscode-charts-blue);
      color: white;
    }

    .status-closed {
      background-color: #8b949e;
      color: white;
    }

    .status-blocked {
      background-color: #da3633;
      color: white;
    }

    .priority-low {
      background-color: #2ea043;
      color: white;
    }

    .priority-medium {
      background-color: #d4a556;
      color: #1f2328;
    }

    .priority-high {
      background-color: #fb8500;
      color: white;
    }

    .priority-urgent {
      background-color: #da3633;
      color: white;
    }

    .task-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-start;
    }

    .start-btn {
      background-color: #0969da;
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
    }

    .start-btn:hover {
      background-color: #0860ca;
    }

    .complete-btn {
      background-color: #2ea043;
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
    }

    .complete-btn:hover {
      background-color: #2c974b;
    }

    .child-row {
      background-color: var(--vscode-editor-background);
    }

    .indent-line {
      width: 2px;
      background-color: var(--vscode-panel-border);
      margin-left: 8px;
      margin-right: 8px;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>Horizon Task List</h1>
  </div>
  <div class="controls">
    <label>View: <select id="view-selector">
        <option value="grid" selected>Grid</option>
        <option value="list">List</option>
      </select></label>
  </div>
  <div class="filters">
    <label><input type="checkbox" id="filter-ready" checked> Ready Tasks</label>
    <label><input type="checkbox" id="filter-open"> Open</label>
    <label><input type="checkbox" id="filter-in_progress"> In Progress</label>
    <label><input type="checkbox" id="filter-closed"> Closed</label>
    <label><input type="checkbox" id="filter-blocked"> Blocked</label>
  </div>
  <div id="task-container">
    <!-- Tasks will be populated here -->
  </div>

  <script>
    const expandedTasks = new Set();

    // Function to check if a task is ready (no blocking dependencies)
    function isReady(task, allTasks) {
      if (!task.dependencies) return true;
      const taskMap = new Map(allTasks.map(t => [t.id, t]));
      return task.dependencies.every(dep => {
        if (dep.type !== 'blocks') return true;
        const depTask = taskMap.get(dep.id);
        return depTask && depTask.status === 'closed';
      });
    }

    function toggleExpand(taskId) {
      if (expandedTasks.has(taskId)) {
        expandedTasks.delete(taskId);
      } else {
        expandedTasks.add(taskId);
      }
      renderTasks(allTasks);
    }

    // Function to render tasks
    function renderTasks(allTasks) {
      const view = document.getElementById('view-selector').value;
      const selectedStatuses = Array.from(document.querySelectorAll('.filters input:checked')).map(cb => cb.id.replace('filter-', ''));
      const filteredTasks = allTasks.filter(task => selectedStatuses.includes(task.status) || (selectedStatuses.includes('ready') && task.status === 'open' && isReady(task, allTasks)));
      const expandedTaskList = getExpandedTasks(allTasks, filteredTasks);
      const taskTree = buildTaskTree(expandedTaskList);

      const container = document.getElementById('task-container');
      container.innerHTML = '';

      if (view === 'list') {
        const ul = document.createElement('ul');
        ul.className = 'task-list';
        ul.style.listStyle = 'none';
        ul.style.padding = '0';
        renderTaskTreeList(taskTree, ul);
        container.appendChild(ul);
      } else if (view === 'grid') {
        const table = document.createElement('table');
        table.className = 'task-grid';
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const titleHeader = document.createElement('th');
        titleHeader.style.display = 'flex';
        titleHeader.style.alignItems = 'center';
        titleHeader.style.justifyContent = 'space-between';
        
        const titleSection = document.createElement('div');
        titleSection.style.display = 'flex';
        titleSection.style.alignItems = 'center';
        titleSection.style.gap = '10px';
        
        const filterIcon = document.createElement('span');
        filterIcon.innerHTML = '▼';
        filterIcon.style.fontSize = '10px';
        
        const titleText = document.createElement('span');
        titleText.textContent = 'Title';
        
        titleSection.appendChild(filterIcon);
        titleSection.appendChild(titleText);
        
        const controlsSection = document.createElement('div');
        controlsSection.className = 'header-controls';
        
        const expandAllBtn = document.createElement('button');
        expandAllBtn.className = 'header-btn';
        expandAllBtn.textContent = 'Expand All';
        expandAllBtn.onclick = () => {
          expandedTasks.clear();
          allTasks.forEach(t => expandedTasks.add(t.id));
          renderTasks(allTasks);
        };
        
        const collapseAllBtn = document.createElement('button');
        collapseAllBtn.className = 'header-btn';
        collapseAllBtn.textContent = 'Collapse All';
        collapseAllBtn.onclick = () => {
          expandedTasks.clear();
          renderTasks(allTasks);
        };
        
        const upBtn = document.createElement('button');
        upBtn.className = 'header-btn';
        upBtn.innerHTML = '↑';
        
        const downBtn = document.createElement('button');
        downBtn.className = 'header-btn';
        downBtn.innerHTML = '↓';
        
        controlsSection.appendChild(expandAllBtn);
        controlsSection.appendChild(collapseAllBtn);
        controlsSection.appendChild(upBtn);
        controlsSection.appendChild(downBtn);
        
        titleHeader.appendChild(titleSection);
        titleHeader.appendChild(controlsSection);
        
        headerRow.appendChild(titleHeader);
        
        ['Status', 'Priority', 'Actions'].forEach(text => {
          const th = document.createElement('th');
          th.textContent = text;
          headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        const tbody = document.createElement('tbody');
        renderTaskTreeGrid(taskTree, tbody, allTasks);
        table.appendChild(tbody);
        
        container.appendChild(table);
      }
    }

    // Function to get expanded tasks including ancestors
    function getExpandedTasks(allTasks, filteredTasks) {
      const taskMap = new Map(allTasks.map(t => [t.id, t]));
      const expanded = new Set(filteredTasks.map(t => t.id));
      const toProcess = [...filteredTasks];

      while (toProcess.length > 0) {
        const task = toProcess.pop();
        (task.dependencies || []).forEach(dep => {
          if (dep.type === 'parent-child') {
            if (!expanded.has(dep.id)) {
              expanded.add(dep.id);
              const parent = taskMap.get(dep.id);
              if (parent) toProcess.push(parent);
            }
          }
        });
      }

      return allTasks.filter(t => expanded.has(t.id));
    }

    // Function to build task hierarchy
    function buildTaskTree(tasks) {
      const taskMap = new Map();
      const roots = [];

      tasks.forEach(task => {
        taskMap.set(task.id, { ...task, children: [] });
      });

      tasks.forEach(task => {
        const node = taskMap.get(task.id);
        const parentDep = (task.dependencies || []).find(dep => dep.type === 'parent-child');
        if (parentDep) {
          const parent = taskMap.get(parentDep.id);
          if (parent) {
            parent.children.push(node);
          } else {
            roots.push(node);
          }
        } else {
          roots.push(node);
        }
      });

      return roots;
    }

    // Function to render task row for grid
    function renderTaskRowGrid(task, level = 0, allTasks) {
      const hasChildren = task.children && task.children.length > 0;
      const isExpanded = expandedTasks.has(task.id);
      
      const tr = document.createElement('tr');
      tr.className = 'task-row';
      if (level > 0) tr.classList.add('child-row');
      
      // Title cell with expand/collapse
      const titleCell = document.createElement('td');
      const titleDiv = document.createElement('div');
      titleDiv.className = 'title-cell';
      titleDiv.style.paddingLeft = `${level * 30}px`;
      
      // Add indent lines for children
      for (let i = 0; i < level; i++) {
        const indentLine = document.createElement('div');
        indentLine.className = 'indent-line';
        indentLine.style.height = '1px';
        indentLine.style.width = '20px';
        indentLine.style.display = 'inline-block';
      }
      
      // Expand/collapse icon
      const expandIcon = document.createElement('span');
      expandIcon.className = hasChildren ? (isExpanded ? 'expand-icon expanded' : 'expand-icon collapsed') : 'expand-icon empty';
      if (hasChildren) {
        expandIcon.onclick = () => toggleExpand(task.id);
      }
      titleDiv.appendChild(expandIcon);
      
      // Type badge
      const typeBadge = document.createElement('span');
      typeBadge.className = `type-badge ${task.type || 'task'}`;
      typeBadge.textContent = task.type || 'Task';
      titleDiv.appendChild(typeBadge);
      
      // Title text
      const titleText = document.createElement('span');
      titleText.className = 'task-title-text';
      titleText.textContent = task.title;
      titleDiv.appendChild(titleText);
      
      titleCell.appendChild(titleDiv);
      tr.appendChild(titleCell);
      
      // Status cell
      const statusCell = document.createElement('td');
      const statusPill = document.createElement('span');
      statusPill.className = `pill status-${task.status}`;
      statusPill.textContent = task.status === 'in_progress' ? 'Open' : (task.status.charAt(0).toUpperCase() + task.status.slice(1));
      statusCell.appendChild(statusPill);
      tr.appendChild(statusCell);
      
      // Priority cell
      const priorityCell = document.createElement('td');
      const priorityPill = document.createElement('span');
      priorityPill.className = `pill priority-${task.priority}`;
      priorityPill.textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
      priorityCell.appendChild(priorityPill);
      tr.appendChild(priorityCell);
      
      // Actions cell
      const actionsCell = document.createElement('td');
      actionsCell.className = 'task-actions';
      if (task.status === 'open') {
        const startBtn = document.createElement('button');
        startBtn.className = 'start-btn';
        startBtn.textContent = 'Start';
        startBtn.onclick = () => startTask(task.id);
        actionsCell.appendChild(startBtn);
      } else if (task.status === 'in_progress') {
        const completeBtn = document.createElement('button');
        completeBtn.className = 'complete-btn';
        completeBtn.textContent = 'Complete';
        completeBtn.onclick = () => completeTask(task.id);
        actionsCell.appendChild(completeBtn);
      }
      tr.appendChild(actionsCell);
      
      return tr;
    }

    // Function to render task tree for grid
    function renderTaskTreeGrid(tree, tbody, allTasks, level = 0) {
      tree.forEach(node => {
        const tr = renderTaskRowGrid(node, level, allTasks);
        tbody.appendChild(tr);
        if (node.children && node.children.length > 0 && expandedTasks.has(node.id)) {
          renderTaskTreeGrid(node.children, tbody, allTasks, level + 1);
        }
      });
    }

    // Function to render task item for list
    function renderTaskItem(task, level = 0) {
      const parentDep = (task.dependencies || []).find(dep => dep.type === 'parent-child');
      const parentId = parentDep ? parentDep.id : '';
      const li = document.createElement('li');
      li.style.backgroundColor = 'var(--vscode-input-background)';
      li.style.border = '1px solid var(--vscode-input-border)';
      li.style.borderRadius = '4px';
      li.style.marginBottom = '10px';
      li.style.padding = '10px';
      li.style.display = 'flex';
      li.style.justifyContent = 'space-between';
      li.style.alignItems = 'center';
      li.style.paddingLeft = level * 40 + 'px';
      li.innerHTML = `
                    <div>
                        <span style="font-weight: bold;">${task.title}</span>
                        ${task.description ? `<div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">${task.description}</div>` : ''}
                        <span class="pill type-${task.type || 'task'}">${task.type || 'task'}</span>
                        <span class="pill status-${task.status}">${task.status}</span>
                        <span class="pill priority-${task.priority}">${task.priority}</span>
                        ${parentId ? `<span class="pill">Parent: ${parentId}</span>` : ''}
                    </div>
                    <div class="task-actions">
                        ${task.status === 'open' ? '<button class="start-btn" onclick="startTask(\'' + task.id + '\')">Start</button>' : ''}
                        ${task.status === 'in_progress' ? '<button class="complete-btn" onclick="completeTask(\'' + task.id + '\')">Complete</button>' : ''}
                    </div>
                `;
      return li;
    }

    // Function to render task tree for list
    function renderTaskTreeList(tree, ul, level = 0) {
      tree.forEach(node => {
        const li = renderTaskItem(node, level);
        ul.appendChild(li);
        if (node.children.length > 0) {
          renderTaskTreeList(node.children, ul, level + 1);
        }
      });
    }

    // Task interaction functions
    function startTask(id) {
      window.vscode = window.vscode || acquireVsCodeApi();
      vscode.postMessage({ type: 'startTask', id });
    }

    function completeTask(id) {
      window.vscode = window.vscode || acquireVsCodeApi();
      vscode.postMessage({ type: 'completeTask', id });
    }

    // Initial render (will be updated via message)
    let allTasks = [];
    renderTasks([]);

    // Listen for messages from extension
    window.addEventListener('message', event => {
      const message = event.data;
      if (message.type === 'updateTasks') {
        allTasks = message.tasks;
        renderTasks(allTasks);
      }
    });

    // Add event listeners for filters
    document.querySelectorAll('.filters input').forEach(cb => {
      cb.addEventListener('change', () => renderTasks(allTasks));
    });

    // Add event listener for view selector
    document.getElementById('view-selector').addEventListener('change', () => renderTasks(allTasks));
  </script>
</body>

</html>